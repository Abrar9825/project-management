<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Project Control System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            200: '#c7d2fe',
                            300: '#a5b4fc',
                            400: '#818cf8',
                            500: '#6366f1',
                            600: '#4f46e5',
                            700: '#4338ca',
                            800: '#3730a3',
                            900: '#312e81'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen gradient-bg flex items-center justify-center p-4">

    <!-- Login Card -->
    <div class="glass-card w-full max-w-md rounded-2xl shadow-2xl p-8 transform transition-all">

        <!-- Logo & Title -->
        <div class="text-center mb-8">
            <div
                class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl mb-4 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">Project Control</h1>
            <p class="text-gray-500 mt-1">Sign in to your workspace</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl text-sm">
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-5">

            <!-- Email Field -->
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207" />
                        </svg>
                    </span>
                    <input type="email" id="email" name="email" placeholder="you@company.com"
                        class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none"
                        required>
                </div>
            </div>

            <!-- Password Field -->
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </span>
                    <input type="password" id="password" name="password" placeholder="••••••••"
                        class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none"
                        required>
                </div>
            </div>

            <!-- Remember & Forgot -->
            <div class="flex items-center justify-between text-sm">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox"
                        class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                    <span class="ml-2 text-gray-600">Remember me</span>
                </label>
                <a href="#" class="text-indigo-600 hover:text-indigo-700 font-medium">Forgot password?</a>
            </div>

            <!-- Login Button -->
            <button type="submit" id="loginBtn"
                class="w-full py-3 px-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2">
                <span id="loginBtnText">Sign In</span>
                <div id="loginSpinner" class="loading-spinner hidden"></div>
            </button>
        </form>

        <!-- Footer -->
        <p class="text-center text-gray-500 text-sm mt-6">
            Powered by <span class="font-medium text-indigo-600">Your Company</span>
        </p>

        <!-- Demo Credentials -->
        <div class="mt-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
            <p class="text-xs text-gray-500 font-medium mb-2 text-center">Demo Login Credentials</p>
            <div class="space-y-1 text-xs text-gray-600">
                <p class="cursor-pointer hover:text-purple-600"
                    onclick="fillCredentials('admin@company.com', 'admin123')"><span
                        class="font-medium text-purple-600">Admin:</span> admin@company.com / admin123</p>
                <p class="cursor-pointer hover:text-blue-600"
                    onclick="fillCredentials('subadmin@company.com', 'subadmin123')"><span
                        class="font-medium text-blue-600">Sub Admin:</span> subadmin@company.com / subadmin123</p>
                <p class="cursor-pointer hover:text-emerald-600"
                    onclick="fillCredentials('bilal@company.com', 'dev123')"><span
                        class="font-medium text-emerald-600">Developer:</span> bilal@company.com / dev123</p>
            </div>
        </div>
    </div>

    <!-- API Script -->
    <script src="/js/api.js"></script>
    <script>
        // Check URL for force logout
        if (window.location.search.includes('logout=true')) {
            localStorage.clear();
            window.location.href = '/login';
        }

        // Check if already logged in - redirect to my-work
        console.log('=== LOGIN PAGE LOADED ===');
        console.log('Token exists:', api.isLoggedIn());
        console.log('User from storage:', api.getUser());

        const storedUser = api.getUser();

        // If token exists, validate it with API before redirecting
        if (api.isLoggedIn() && storedUser && storedUser.name) {
            console.log('Token found, validating with API...');
            api.getMe().then(result => {
                if (result.success && result.data) {
                    console.log('Token valid, redirecting...');
                    window.location.href = result.data.role === 'client' ? '/client-portal' : '/my-work';
                } else {
                    console.log('Token invalid, clearing storage');
                    localStorage.clear();
                    window.location.href = '/login';
                }
            }).catch(err => {
                console.log('Token validation error:', err);
                localStorage.clear();
                window.location.href = '/login';
            });
        } else if (api.isLoggedIn() && (!storedUser || !storedUser.name)) {
            // Token exists but no valid user - clear and stay on login
            console.log('Token exists but no valid user, clearing storage');
            localStorage.clear();
        }
        localStorage.clear();


        // Fill demo credentials on click
        function fillCredentials(email, password) {
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
        }

        // Show/hide loading state
        function setLoading(loading) {
            document.getElementById('loginBtn').disabled = loading;
            document.getElementById('loginBtnText').textContent = loading ? 'Signing in...' : 'Sign In';
            document.getElementById('loginSpinner').classList.toggle('hidden', !loading);
        }

        // Login form handler - USES BACKEND API
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            document.getElementById('errorMessage').classList.add('hidden');

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!email || !password) {
                document.getElementById('errorMessage').textContent = 'Please enter email and password';
                document.getElementById('errorMessage').classList.remove('hidden');
                return;
            }

            setLoading(true);

            try {
                const result = await api.login(email, password);
                console.log('Login response:', result);

                if (result.success) {
                    console.log('Setting token:', result.token);
                    console.log('Setting user:', result.data);

                    // Store token and user data
                    api.setToken(result.token);
                    api.setUser(result.data);

                    // Verify storage
                    console.log('Token in storage:', localStorage.getItem('token'));
                    console.log('User in storage:', localStorage.getItem('user'));

                    // Redirect based on role
                    setTimeout(() => {
                        window.location.href = result.data.role === 'client' ? '/client-portal' : '/my-work';
                    }, 500);
                } else {
                    document.getElementById('errorMessage').textContent = result.error || 'Invalid email or password';
                    document.getElementById('errorMessage').classList.remove('hidden');
                }
            } catch (error) {
                document.getElementById('errorMessage').textContent = 'Connection failed. Please check if server is running.';
                document.getElementById('errorMessage').classList.remove('hidden');
                console.error('Login error:', error);
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>

</html>