<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Detail | Project Control System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .stage-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stage-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stage-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stage-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .stage-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .stage-gradient-6 { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); }
        .stage-gradient-7 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        
        .stage-card.expanded .stage-content { max-height: 2000px; }
        .stage-card .stage-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .stage-card.expanded .chevron { transform: rotate(180deg); }
        .chevron { transition: transform 0.3s ease; }

        .tab-btn { transition: all 0.3s ease; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #4f46e5; border-bottom-color: #4f46e5; background: #eef2ff; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-white border-b border-gray-100 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                    </div>
                    <span class="text-xl font-bold text-gray-800">ProjectControl</span>
                </div>
                <div class="hidden md:flex items-center space-x-1">
                    <a class='px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium' href='/my-work'>My Work</a>
                    <a class='px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium admin-subadmin-only' href='/projects'>Projects</a>
                    <a class='px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium admin-only' href='/add-project'>Add Project</a>
                    <a class='px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium admin-only' href='/users'>Users</a>
                    <a class='px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium admin-subadmin-only' href='/documents'>Documents</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a class='flex items-center space-x-3 hover:bg-gray-50 rounded-lg px-2 py-1 transition-all' href='/profile'>
                        <div class="w-9 h-9 bg-gradient-to-br from-emerald-400 to-cyan-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
                            <span id="userInitials">AK</span>
                        </div>
                        <span class="hidden sm:block text-sm font-medium text-gray-700" id="userName">Ahmed Khan</span>
                    </a>
                    <button onclick="logout()" class="p-2 text-gray-400 hover:text-red-500 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sticky Project Header -->
    <div class="bg-white border-b border-gray-100 sticky top-16 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <a class='p-2 hover:bg-gray-100 rounded-lg transition-all' href='/projects'>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                        </svg>
                    </a>
                    <div>
                        <div class="flex items-center gap-3">
                            <h1 class="text-2xl font-bold text-gray-900" id="projectTitle">E-Commerce Platform</h1>
                            <span class="w-3 h-3 rounded-full bg-amber-500 animate-pulse"></span>
                        </div>
                        <p class="text-gray-500" id="projectClient">TechMart Inc.</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <a id="docCenterBtn" href="#" class="px-3 py-1.5 text-sm font-medium rounded-lg bg-teal-50 text-teal-700 border border-teal-200 hover:bg-teal-100 admin-subadmin-only">üìÑ Doc Center</a>
                    <a id="clientPortalBtn" href="#" class="px-3 py-1.5 text-sm font-medium rounded-lg bg-purple-50 text-purple-700 border border-purple-200 hover:bg-purple-100 admin-subadmin-only">üë§ Client Portal</a>
                    <span class="px-3 py-1 text-sm font-medium rounded-lg bg-orange-100 text-orange-700 border border-orange-200" id="projectPriority">High Priority</span>
                    <span class="px-3 py-1 text-sm font-medium rounded-lg bg-blue-100 text-blue-700 border border-blue-200" id="projectProgress">65% Complete</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white border-b border-gray-200 sticky top-[132px] z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex overflow-x-auto -mb-px">
                <button onclick="switchTab('tasks')" class="tab-btn active px-6 py-4 text-sm font-semibold whitespace-nowrap flex items-center gap-2" data-tab="tasks">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                    Tasks
                </button>
                <button onclick="switchTab('stages')" class="tab-btn px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" data-tab="stages">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                    Stages
                </button>
                <button onclick="switchTab('client-payments')" class="tab-btn px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2 admin-only" data-tab="client-payments">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Client Payments
                </button>
                <button onclick="switchTab('dev-payments')" class="tab-btn px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2 admin-only" data-tab="dev-payments">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    Developer Payments
                </button>
                <button onclick="switchTab('activity')" class="tab-btn px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" data-tab="activity">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    Activity & Remarks
                </button>
                <button onclick="switchTab('meetings')" class="tab-btn px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" data-tab="meetings">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    Meetings
                </button>
                <button onclick="switchTab('assets')" class="tab-btn px-6 py-4 text-sm font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap flex items-center gap-2" data-tab="assets">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                    Assets
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- ==================== TAB 1: TASKS ==================== -->
        <div class="tab-content active" id="tab-tasks">

            <!-- Task Assignment (Admin Only) -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 mb-6 overflow-hidden admin-only">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 px-6 py-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        Assign Task to Team Member
                    </h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                        <select id="taskRole" onchange="updateDeveloperDropdown()" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="">Select Role</option>
                            <option value="Frontend Dev">Frontend Dev</option>
                            <option value="Backend Dev">Backend Dev</option>
                            <option value="Designer">Designer</option>
                            <option value="QA Engineer">QA Engineer</option>
                            <option value="DevOps">DevOps</option>
                            <option value="Project Manager">Project Manager</option>
                        </select>
                        <select id="taskDeveloper" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                            <option value="">Select Developer</option>
                        </select>
                        <input type="text" id="taskTitle" placeholder="Task title" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        <input type="date" id="taskDeadline" class="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                        <button onclick="addTask()" class="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-medium rounded-xl hover:shadow-lg transition-all">
                            Add Task
                        </button>
                    </div>
                    <textarea id="taskDescription" placeholder="Task description (optional)" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none resize-none"></textarea>
                </div>
            </div>

            <!-- Assigned Tasks -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100">
                    <h2 class="text-lg font-bold text-gray-900">Assigned Tasks</h2>
                </div>
                <div class="divide-y divide-gray-100" id="tasksList"></div>
            </div>
        </div>

        <!-- ==================== TAB 2: STAGES ==================== -->
        <div class="tab-content" id="tab-stages">
            <div class="space-y-4" id="stagesContainer"></div>
        </div>

        <!-- ==================== TAB 3: CLIENT PAYMENTS ==================== -->
        <div class="tab-content" id="tab-client-payments">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-emerald-500 to-teal-600 px-6 py-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Client Payments
                    </h2>
                    <p class="text-emerald-100 text-sm" id="clientPaymentTotal">Total: ‚Çπ0</p>
                </div>
                <div class="p-6" id="clientPaymentsList"></div>
                
                <!-- Add Payment (Admin) -->
                <div class="px-6 pb-6 admin-only">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <select id="newPaymentLabel" class="px-4 py-2 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                            <option value="Advance Payment">Advance Payment</option>
                            <option value="1st Milestone">1st Milestone</option>
                            <option value="2nd Milestone">2nd Milestone</option>
                            <option value="3rd Milestone">3rd Milestone</option>
                            <option value="4th Milestone">4th Milestone</option>
                            <option value="5th Milestone">5th Milestone</option>
                            <option value="Final Payment">Final Payment</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="number" id="newPaymentAmount" placeholder="Amount (‚Çπ)" class="px-4 py-2 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                        <input type="date" id="newPaymentDate" class="px-4 py-2 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500 text-sm">
                        <button onclick="addClientPayment()" class="px-5 py-2 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-medium rounded-xl hover:shadow-lg transition-all text-sm">
                            Add Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 4: DEVELOPER PAYMENTS ==================== -->
        <div class="tab-content" id="tab-dev-payments">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4">
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                        Developer Payments
                    </h2>
                    <p class="text-blue-100 text-sm">Team payment history</p>
                </div>
                <div class="p-6" id="devPaymentsList"></div>
                
                <!-- Add Dev Payment (Admin) -->
                <div class="px-6 pb-6 admin-only">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                        <select id="devPaymentRole" class="px-3 py-2 border border-gray-200 rounded-xl outline-none text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Developer...</option>
                        </select>
                        <input type="number" id="devPaymentAmount" placeholder="Amount (‚Çπ)" class="px-3 py-2 border border-gray-200 rounded-xl outline-none text-sm focus:ring-2 focus:ring-blue-500">
                        <input type="date" id="devPaymentDate" class="px-3 py-2 border border-gray-200 rounded-xl outline-none text-sm focus:ring-2 focus:ring-blue-500">
                        <button onclick="addDevPayment()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-sm font-medium rounded-xl hover:shadow-lg transition-all">
                            Pay Developer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 5: ACTIVITY & REMARKS ==================== -->
        <div class="tab-content" id="tab-activity">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Activity Timeline -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-slate-600 to-slate-800 px-6 py-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Project Activity
                        </h3>
                    </div>
                    <div class="p-6 max-h-[500px] overflow-y-auto space-y-4" id="activityList"></div>
                </div>

                <!-- Remarks Section -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-amber-500 to-orange-600 px-6 py-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                            Remarks & Notes
                        </h3>
                    </div>
                    <div class="p-6">
                        <div class="flex gap-3 mb-4">
                            <input type="text" id="remarkInput" placeholder="Add a remark..." class="flex-1 px-4 py-3 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-amber-500">
                            <button onclick="addRemark()" class="px-5 py-3 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-medium rounded-xl hover:shadow-lg transition-all">
                                Add
                            </button>
                        </div>
                        <div class="max-h-[400px] overflow-y-auto space-y-3" id="remarksList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== TAB 6: MEETINGS ==================== -->
        <div class="tab-content" id="tab-meetings">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6 admin-only">
                <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                        Schedule Meeting
                    </h3>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Meeting Title *</label>
                            <input type="text" id="mtgTitle" placeholder="e.g. Weekly Check-in" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Meeting Type</label>
                            <select id="mtgType" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="google-meet">Google Meet</option>
                                <option value="zoom">Zoom</option>
                                <option value="teams">Microsoft Teams</option>
                                <option value="phone-call">Phone Call</option>
                                <option value="in-person">In Person</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Meeting Link</label>
                            <input type="url" id="mtgLink" placeholder="https://meet.google.com/..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Date & Time *</label>
                            <input type="datetime-local" id="mtgDate" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Duration (minutes)</label>
                            <input type="number" id="mtgDuration" value="30" min="5" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Stage (optional)</label>
                            <select id="mtgStage" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="">General</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="text-xs font-semibold text-gray-600 mb-1 block">Agenda (optional)</label>
                        <textarea id="mtgAgenda" rows="2" placeholder="Meeting agenda..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                    </div>
                    <button onclick="scheduleMeeting()" class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-800 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Schedule Meeting
                    </button>
                </div>
            </div>
            <!-- Meetings List -->
            <div class="space-y-4" id="meetingsList">
                <div class="text-center text-gray-400 py-12">Loading meetings...</div>
            </div>
        </div>

        <!-- ==================== TAB 7: ASSETS ==================== -->
        <div class="tab-content" id="tab-assets">
            <!-- Assets Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-xl bg-blue-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-gray-900" id="assetTotalCount">0</p>
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Total Requests</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-xl bg-amber-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-amber-600" id="assetPendingCount">0</p>
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Pending</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                    <div class="flex items-center gap-3">
                        <div class="w-11 h-11 rounded-xl bg-emerald-100 flex items-center justify-center">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-emerald-600" id="assetReceivedCount">0</p>
                            <p class="text-xs font-medium text-gray-500 uppercase tracking-wide">Received</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send New Asset Request -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6 admin-only">
                <div class="bg-gradient-to-r from-violet-600 to-purple-700 px-6 py-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Send Asset Request to Client
                    </h3>
                    <p class="text-violet-200 text-sm">Request files, logos, content, API keys etc. from the client</p>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Stage *</label>
                            <select id="globalAssetStage" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-violet-500 text-sm bg-white"></select>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Asset Name *</label>
                            <input type="text" id="globalAssetLabel" placeholder="e.g. Company Logo, Brand Guide" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-violet-500 text-sm">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Type</label>
                            <select id="globalAssetType" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-violet-500 text-sm bg-white">
                                <option value="logo">Logo</option>
                                <option value="content">Content</option>
                                <option value="brand-guide">Brand Guide</option>
                                <option value="api-keys">API Keys</option>
                                <option value="approval">Approval</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-gray-600 mb-1 block">Note (optional)</label>
                            <input type="text" id="globalAssetNote" placeholder="Any instructions..." class="w-full px-4 py-2.5 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-violet-500 text-sm">
                        </div>
                    </div>
                    <button onclick="sendGlobalAssetRequest()" class="px-6 py-2.5 bg-gradient-to-r from-violet-600 to-purple-700 text-white font-semibold rounded-xl hover:shadow-lg transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                        Send Request
                    </button>
                </div>
            </div>

            <!-- All Asset Requests List -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-900">All Asset Requests</h3>
                    <div class="flex gap-2">
                        <button onclick="filterAssets('all')" class="asset-filter-btn active px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-900 text-white" data-filter="all">All</button>
                        <button onclick="filterAssets('pending')" class="asset-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200" data-filter="pending">Pending</button>
                        <button onclick="filterAssets('received')" class="asset-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200" data-filter="received">Received</button>
                    </div>
                </div>
                <div class="divide-y divide-gray-100" id="assetsTabList">
                    <div class="text-center py-12 text-gray-400">Loading assets...</div>
                </div>
            </div>
        </div>

    </main>

    <script src="/js/api.js"></script>
    <script>
        // ==================== GLOBALS ====================
        const projectId = new URLSearchParams(window.location.search).get('id');
        const TOKEN = localStorage.getItem('token');
        const USER = JSON.parse(localStorage.getItem('user') || '{}');
        const HEADERS = { 'Authorization': 'Bearer ' + TOKEN, 'Content-Type': 'application/json' };

        // Set Doc Center & Client Portal links
        if (projectId) {
            const dcBtn = document.getElementById('docCenterBtn');
            const cpBtn = document.getElementById('clientPortalBtn');
            if (dcBtn) dcBtn.href = '/document-center?id=' + projectId;
            if (cpBtn) cpBtn.href = '/client-portal?id=' + projectId;
        }

        let project = null;
        let tasks = [];
        let stages = [];
        let clientPayments = [];
        let devPayments = [];
        let teamMembers = [];
        let activities = [];
        let remarks = [];
        let editingMeetingId = null;

        const statusConfig = {
            completed: { dot: 'bg-emerald-500', label: 'Completed', bg: 'bg-emerald-50', text: 'text-emerald-700' },
            'in-progress': { dot: 'bg-blue-500', label: 'In Progress', bg: 'bg-blue-50', text: 'text-blue-700' },
            pending: { dot: 'bg-gray-400', label: 'Pending', bg: 'bg-gray-50', text: 'text-gray-600' },
            warning: { dot: 'bg-amber-500', label: 'At Risk', bg: 'bg-amber-50', text: 'text-amber-700' },
            success: { dot: 'bg-emerald-500', label: 'Healthy', bg: 'bg-emerald-50', text: 'text-emerald-700' },
            blocked: { dot: 'bg-red-500', label: 'Blocked', bg: 'bg-red-50', text: 'text-red-700' }
        };

        // ==================== HELPERS ====================
        function formatTimeAgo(dateStr) {
            if (!dateStr) return 'Just now';
            const diff = Math.floor((Date.now() - new Date(dateStr).getTime()) / 1000);
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
            if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
            if (diff < 604800) return Math.floor(diff / 86400) + ' days ago';
            return new Date(dateStr).toLocaleDateString();
        }

        function formatDuration(startedAt, completedAt) {
            if (!startedAt) return '‚Äî';
            const totalSec = Math.floor((new Date(completedAt || Date.now()) - new Date(startedAt)) / 1000);
            if (totalSec <= 0) return '‚Äî';
            const d = Math.floor(totalSec / 86400), h = Math.floor((totalSec % 86400) / 3600), m = Math.floor((totalSec % 3600) / 60);
            if (d > 0) return d + 'd ' + h + 'h';
            if (h > 0) return h + 'h ' + m + 'm';
            return m + 'm';
        }

        function formatDT(dt) {
            if (!dt) return '‚Äî';
            return new Date(dt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function addLocalActivity(action, icon) {
            activities.unshift({ user: USER.name || 'User', action: action, time: 'Just now', icon: icon || 'üìå' });
            renderActivities();
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(function(btn) {
                btn.classList.remove('active');
                btn.classList.add('text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(function(c) {
                c.classList.remove('active');
            });
            var btn = document.querySelector('.tab-btn[data-tab="' + tabName + '"]');
            if (btn) { btn.classList.add('active'); btn.classList.remove('text-gray-500'); }
            var content = document.getElementById('tab-' + tabName);
            if (content) content.classList.add('active');
            if (tabName === 'stages' && stages.length > 0) {
                var ip = stages.find(function(s) { return s.status === 'in-progress'; });
                if (ip) setTimeout(function() { toggleStage(ip.id); }, 200);
            }
            if (tabName === 'assets') {
                renderAssetsTab();
            }
        }

        // ==================== TOGGLE STAGE ====================
        function toggleStage(id) {
            var el = document.getElementById('stage-' + id);
            if (el) el.classList.toggle('expanded');
        }

        // ==================== RENDER TASKS ====================
        function renderTasks() {
            var container = document.getElementById('tasksList');
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p class="p-6 text-gray-500 text-center">No tasks assigned yet</p>';
                return;
            }
            var statusBg = { pending: 'bg-amber-50 text-amber-700', 'in-progress': 'bg-blue-50 text-blue-700', completed: 'bg-emerald-50 text-emerald-700', blocked: 'bg-red-50 text-red-700' };
            var statusLabel = { pending: 'Pending', 'in-progress': 'In Progress', completed: 'Completed', blocked: 'Blocked' };
            var statusIcon = { pending: '‚è≥', 'in-progress': '‚ñ∂Ô∏è', completed: '‚úÖ', blocked: '‚õî' };

            container.innerHTML = tasks.map(function(task) {
                var actionBtn = '';
                if (task.status === 'pending') {
                    actionBtn = '<button onclick="startTaskAPI(\'' + task.id + '\')" class="px-3 py-1.5 bg-blue-100 text-blue-700 text-xs font-medium rounded-lg hover:bg-blue-200 transition-all flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> Start</button>';
                } else if (task.status === 'in-progress') {
                    actionBtn = '<button onclick="completeTaskAPI(\'' + task.id + '\')" class="px-3 py-1.5 bg-emerald-100 text-emerald-700 text-xs font-medium rounded-lg hover:bg-emerald-200 transition-all flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Complete</button>';
                }
                var timeInfo = '';
                if (task.status === 'in-progress' && task.startedAt) timeInfo = '<span class="text-xs text-blue-600 font-medium">‚ñ∂ ' + formatDuration(task.startedAt, null) + '</span>';
                else if (task.status === 'completed' && task.startedAt) timeInfo = '<span class="text-xs text-emerald-600 font-medium">‚úÖ ' + formatDuration(task.startedAt, task.completedAt) + '</span>';

                return '<div class="p-5 hover:bg-gray-50 transition-all"><div class="flex items-start justify-between gap-4"><div class="flex-1"><div class="flex items-center gap-2 mb-2"><span class="text-base">' + (statusIcon[task.status] || '') + '</span><span class="px-2.5 py-0.5 text-xs font-medium bg-indigo-100 text-indigo-700 rounded-full">' + task.role + '</span><span class="text-sm text-gray-400">' + (task.assignee || 'Unassigned') + '</span>' + timeInfo + '</div><p class="font-semibold text-gray-900">' + task.title + '</p>' + (task.description ? '<p class="text-sm text-gray-500 mt-1">' + task.description + '</p>' : '') + '<div class="flex items-center gap-3 mt-2 text-xs text-gray-400">' + (task.startedAt ? '<span>Started: ' + formatDT(task.startedAt) + '</span>' : '') + (task.completedAt ? '<span>Completed: ' + formatDT(task.completedAt) + '</span>' : '') + '</div></div><div class="text-right flex-shrink-0"><p class="text-xs text-gray-400 mb-1">Deadline</p><p class="text-sm font-medium text-gray-700">' + new Date(task.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + '</p></div><div class="flex items-center gap-2"><span class="px-3 py-1.5 text-xs font-medium rounded-lg ' + (statusBg[task.status] || '') + '">' + (statusLabel[task.status] || task.status) + '</span>' + actionBtn + '</div></div></div>';
            }).join('');
        }

        // ==================== RENDER STAGES ====================
        function renderStages() {
            var container = document.getElementById('stagesContainer');
            if (!container) return;

            if (!stages || stages.length === 0) {
                container.innerHTML = '<p class="p-6 text-gray-500 text-center">No stages found for this project.</p>';
                return;
            }

            // Preserve expanded state before re-rendering
            var expandedIds = [];
            var existingCards = container.querySelectorAll('.stage-card.expanded');
            for (var e = 0; e < existingCards.length; e++) {
                var cardId = existingCards[e].id.replace('stage-', '');
                expandedIds.push(cardId);
            }

            var html = '';
            for (var i = 0; i < stages.length; i++) {
                var stage = stages[i];
                var sid = String(stage.id);
                var status = statusConfig[stage.status] || statusConfig['pending'];
                var deadlineStr = stage.deadline ? new Date(stage.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'No date';
                var assignedName = stage.assigned || 'Unassigned';

                // Build content based on type
                var contentHtml = '';

                if (stage.type === 'checklist') {
                    var itemsHtml = '';
                    var items = stage.items || [];
                    for (var j = 0; j < items.length; j++) {
                        var item = items[j];
                        var iid = String(item.id);
                        var checkedAttr = item.done ? 'checked' : '';
                        var disabledAttr = stage.approved ? 'disabled' : '';
                        var itemBg = item.done ? 'bg-emerald-50 border border-emerald-200' : 'bg-gray-50 border border-gray-200';
                        var textClass = item.done ? 'line-through text-gray-400' : 'text-gray-700';
                        var checkMark = item.done ? '<span class="ml-auto text-emerald-500 font-bold">‚úì</span>' : '';
                        itemsHtml += '<label class="flex items-center gap-3 p-3 rounded-xl ' + itemBg + ' cursor-pointer transition-all hover:shadow-sm">' +
                            '<input type="checkbox" ' + checkedAttr + ' ' + disabledAttr + ' onchange="event.stopPropagation(); toggleChecklistItem(\'' + sid + '\', \'' + iid + '\')" class="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">' +
                            '<span class="' + textClass + '">' + item.text + '</span>' + checkMark + '</label>';
                    }
                    contentHtml = '<div class="space-y-3 mb-4">' + itemsHtml + '</div>';
                    if (stage.approved) {
                        contentHtml += '<div class="px-4 py-3 bg-emerald-100 rounded-xl text-emerald-700 font-medium flex items-center gap-2 border border-emerald-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Stage Approved</div>';
                    } else {
                        contentHtml += '<button onclick="approveStage(\'' + sid + '\')" class="px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-medium rounded-xl hover:shadow-lg transition-all">Approve Stage</button>';
                    }

                } else if (stage.type === 'development') {
                    var healthStatus = statusConfig[stage.health] || statusConfig['pending'];
                    var healthBorderColor = stage.health === 'success' ? 'border-emerald-200' : 'border-amber-200';
                    var repoUrl = stage.repoUrl || '';
                    var liveUrl = stage.liveUrl || '';
                    contentHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-2">Repository URL</label><input type="url" id="repo-' + sid + '" value="' + repoUrl + '" placeholder="https://github.com/..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></div>' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-2">Live URL</label><input type="url" id="live-' + sid + '" value="' + liveUrl + '" placeholder="https://..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></div>' +
                        '</div>' +
                        '<div class="flex items-center justify-between p-4 rounded-xl ' + healthStatus.bg + ' border ' + healthBorderColor + ' mb-4"><div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full ' + healthStatus.dot + ' animate-pulse"></span><span class="font-medium ' + healthStatus.text + '">Health: ' + healthStatus.label + '</span></div></div>';
                    if (stage.status === 'completed') {
                        contentHtml += '<div class="px-4 py-3 bg-emerald-100 rounded-xl text-emerald-700 font-medium flex items-center gap-2 border border-emerald-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Development Completed</div>';
                    } else {
                        contentHtml += '<div class="flex gap-3"><button onclick="saveLinks(\'' + sid + '\')" class="px-5 py-2.5 bg-indigo-100 text-indigo-700 font-medium rounded-xl hover:bg-indigo-200 transition-all">Save Links</button>' +
                            '<button onclick="markReady(\'' + sid + '\')" class="px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-medium rounded-xl hover:shadow-lg transition-all">Mark as Ready</button></div>';
                    }

                } else if (stage.type === 'hosting') {
                    var selProvider = stage.hostingProvider || '';
                    var selDomain = stage.domainUrl || '';
                    var sslChecked = stage.sslStatus === 'active' ? 'checked' : '';
                    contentHtml = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-2">Hosting Provider</label><select id="hosting-' + sid + '" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-white"><option value="">Select provider</option><option value="aws"' + (selProvider === 'aws' ? ' selected' : '') + '>AWS</option><option value="vercel"' + (selProvider === 'vercel' ? ' selected' : '') + '>Vercel</option><option value="digitalocean"' + (selProvider === 'digitalocean' ? ' selected' : '') + '>DigitalOcean</option><option value="heroku"' + (selProvider === 'heroku' ? ' selected' : '') + '>Heroku</option><option value="custom"' + (selProvider === 'custom' ? ' selected' : '') + '>Custom Server</option></select></div>' +
                        '<div><label class="block text-sm font-medium text-gray-700 mb-2">Domain URL</label><input type="url" id="domain-' + sid + '" value="' + selDomain + '" placeholder="https://example.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"></div></div>' +
                        '<div class="flex items-center gap-4 mb-4"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="ssl-' + sid + '" ' + sslChecked + ' onclick="event.stopPropagation()" class="w-5 h-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500"><span class="text-gray-700">SSL Certificate Installed</span></label></div>' +
                        '<div class="flex gap-3"><button onclick="saveHosting(\'' + sid + '\')" class="px-5 py-2.5 bg-gradient-to-r from-purple-500 to-pink-600 text-white font-medium rounded-xl hover:shadow-lg transition-all">Save Hosting Details</button>' +
                        '<button onclick="markReady(\'' + sid + '\')" class="px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-medium rounded-xl hover:shadow-lg transition-all">Mark as Ready</button></div>';

                } else if (stage.type === 'delivery') {
                    var delsHtml = '';
                    var deliveries = stage.deliveries || [];
                    for (var k = 0; k < deliveries.length; k++) {
                        var del = deliveries[k];
                        var did = String(del.id);
                        var delBorder = del.approved ? 'border-emerald-300 bg-emerald-50' : 'border-gray-200 bg-gray-50';
                        var delCircleBg = del.approved ? 'bg-emerald-500' : 'bg-gray-300';
                        var delCircleText = del.approved ? '‚úì' : String(k + 1);
                        var delChecked = del.approved ? 'checked' : '';
                        delsHtml += '<div class="flex items-center justify-between p-4 rounded-xl border-2 ' + delBorder + '">' +
                            '<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full ' + delCircleBg + ' flex items-center justify-center text-white font-bold text-lg">' + delCircleText + '</div>' +
                            '<div><p class="font-semibold text-gray-900">' + del.name + '</p><p class="text-sm text-gray-500">' + (del.date || 'Not scheduled') + '</p></div></div>' +
                            '<label class="flex items-center gap-3 cursor-pointer"><span class="text-sm font-medium text-gray-600">Approved</span>' +
                            '<div class="relative"><input type="checkbox" ' + delChecked + ' onchange="event.stopPropagation(); toggleDelivery(\'' + sid + '\', \'' + did + '\')" class="sr-only peer">' +
                            '<div class="w-12 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-emerald-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>' +
                            '</div></label></div>';
                    }
                    var allDeliveriesApproved = deliveries.length > 0 && deliveries.every(function(d) { return d.approved; });
                    contentHtml = '<div class="space-y-4 mb-4">' + delsHtml + '</div>';
                    if (stage.status === 'completed') {
                        contentHtml += '<div class="px-4 py-3 bg-emerald-100 rounded-xl text-emerald-700 font-medium flex items-center gap-2 border border-emerald-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Delivery Completed</div>';
                    } else {
                        contentHtml += '<button onclick="markReady(\'' + sid + '\')" class="px-5 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-medium rounded-xl hover:shadow-lg transition-all' + (allDeliveriesApproved ? '' : ' opacity-50 cursor-not-allowed') + '"' + (allDeliveriesApproved ? '' : ' disabled title="Approve all deliveries first"') + '>Mark Delivery Complete</button>';
                    }
                }

                // Asset Requests section for every stage
                var assets = stage.assetRequests || [];
                var assetsHtml = '<div class="mt-4 pt-4 border-t border-gray-100 admin-only">' +
                    '<div class="flex items-center justify-between mb-3">' +
                        '<h4 class="text-sm font-bold text-gray-700 flex items-center gap-2"><svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg> Asset Requests</h4>' +
                        '<button onclick="event.stopPropagation(); toggleAssetForm(\'' + sid + '\')" class="text-xs font-semibold text-blue-600 hover:text-blue-800 flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Add Request</button>' +
                    '</div>';
                // Inline add form (hidden by default)
                assetsHtml += '<div id="assetForm-' + sid + '" class="hidden mb-3 p-3 bg-blue-50 rounded-xl border border-blue-200">' +
                    '<div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">' +
                        '<input type="text" id="assetLabel-' + sid + '" placeholder="Asset name (e.g. Logo Files)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">' +
                        '<select id="assetType-' + sid + '" class="px-3 py-2 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white">' +
                            '<option value="logo">Logo</option><option value="content">Content</option><option value="brand-guide">Brand Guide</option><option value="api-keys">API Keys</option><option value="approval">Approval</option><option value="other">Other</option>' +
                        '</select>' +
                        '<input type="text" id="assetNote-' + sid + '" placeholder="Note (optional)" class="px-3 py-2 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">' +
                    '</div>' +
                    '<button onclick="event.stopPropagation(); addAssetRequest(\'' + sid + '\')" class="px-4 py-1.5 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition-colors">Send Request</button>' +
                '</div>';
                // List existing
                if (assets.length > 0) {
                    for (var a = 0; a < assets.length; a++) {
                        var ast = assets[a];
                        var astStatusBg = ast.status === 'received' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : ast.status === 'rejected' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-amber-100 text-amber-700 border-amber-200';
                        var astIcon = ast.status === 'received' ? '<svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' :
                            '<svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
                        var fileLink = ast.fileUrl ? '<a href="' + ast.fileUrl + '" target="_blank" download class="text-xs text-blue-600 hover:underline flex items-center gap-1"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg> ' + (ast.fileName || 'Download') + '</a>' : '';
                        assetsHtml += '<div class="flex items-center justify-between p-3 rounded-xl border ' + astStatusBg + ' mb-2">' +
                            '<div class="flex items-center gap-3">' + astIcon +
                                '<div><p class="text-sm font-semibold">' + ast.label + '</p>' +
                                    '<p class="text-xs opacity-75">' + (ast.type || 'other') + (ast.note ? ' ‚Äî ' + ast.note : '') + '</p>' +
                                    fileLink +
                                '</div>' +
                            '</div>' +
                            '<div class="flex items-center gap-2">' +
                                '<span class="px-2.5 py-1 text-xs font-bold rounded-lg capitalize">' + ast.status + '</span>' +
                                '<button onclick="event.stopPropagation(); deleteAssetRequest(\'' + sid + '\', \'' + ast.id + '\', \'' + (ast.label || '').replace(/'/g, "\\'") + '\')" class="p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Delete">' +
                                    '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>' +
                                '</button>' +
                            '</div>' +
                        '</div>';
                    }
                } else {
                    assetsHtml += '<p class="text-xs text-gray-400 italic">No asset requests for this stage</p>';
                }
                assetsHtml += '</div>';
                contentHtml += assetsHtml;

                // Build card
                html += '<div class="stage-card bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden" id="stage-' + sid + '">' +
                    '<div class="flex items-center justify-between p-5 cursor-pointer hover:bg-gray-50 transition-all" onclick="toggleStage(\'' + sid + '\')">' +
                        '<div class="flex items-center gap-4">' +
                            '<div class="w-14 h-14 ' + (stage.gradient || 'stage-gradient-1') + ' rounded-xl flex items-center justify-center text-2xl shadow-lg">' + (stage.icon || 'üìã') + '</div>' +
                            '<div><div class="flex items-center gap-3">' +
                                '<h3 class="text-lg font-bold text-gray-900">' + stage.name + '</h3>' +
                                '<span class="w-2.5 h-2.5 rounded-full ' + status.dot + (stage.status !== 'pending' ? ' animate-pulse' : '') + '"></span>' +
                                '<span class="px-2.5 py-0.5 text-xs font-medium rounded-full ' + status.bg + ' ' + status.text + '">' + status.label + '</span>' +
                            '</div><p class="text-gray-500 text-sm">' + (stage.summary || '') + '</p></div>' +
                        '</div>' +
                        '<div class="flex items-center gap-6">' +
                            '<div class="text-right hidden sm:block"><p class="text-xs text-gray-400 uppercase tracking-wide">Assigned</p><p class="font-medium text-gray-700">' + assignedName + '</p></div>' +
                            '<div class="text-right hidden sm:block"><p class="text-xs text-gray-400 uppercase tracking-wide">Deadline</p><p class="font-medium text-gray-700">' + deadlineStr + '</p></div>' +
                            '<svg class="w-6 h-6 text-gray-400 chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>' +
                        '</div>' +
                    '</div>' +
                    '<div class="stage-content"><div class="px-5 pb-5 pt-2 border-t border-gray-100">' +
                        '<div class="flex gap-4 mb-4 sm:hidden">' +
                            '<div class="flex-1 p-3 bg-gray-50 rounded-xl"><p class="text-xs text-gray-400 uppercase">Assigned</p><p class="font-medium text-gray-700">' + assignedName + '</p></div>' +
                            '<div class="flex-1 p-3 bg-gray-50 rounded-xl"><p class="text-xs text-gray-400 uppercase">Deadline</p><p class="font-medium text-gray-700">' + deadlineStr + '</p></div>' +
                        '</div>' +
                        contentHtml +
                    '</div></div>' +
                '</div>';
            }

            container.innerHTML = html;

            // Restore expanded state after re-rendering
            for (var r = 0; r < expandedIds.length; r++) {
                var card = document.getElementById('stage-' + expandedIds[r]);
                if (card) card.classList.add('expanded');
            }
        }

        // ==================== RENDER CLIENT PAYMENTS ====================
        function renderClientPayments() {
            var container = document.getElementById('clientPaymentsList');
            if (!container) return;

            if (clientPayments.length === 0) {
                container.innerHTML = '<div class="text-center py-8"><p class="text-gray-400 mb-4">No payment records found for this project</p><button onclick="generatePaymentSchedule()" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all admin-only">Generate Payment Schedule</button></div>';
                document.getElementById('clientPaymentTotal').textContent = 'Total: ‚Çπ0';
                return;
            }

            var total = clientPayments.reduce(function(s, p) { return s + (p.amount || 0); }, 0);
            var received = clientPayments.filter(function(p) { return p.status === 'received'; }).reduce(function(s, p) { return s + (p.amount || 0); }, 0);
            document.getElementById('clientPaymentTotal').textContent = 'Total: ‚Çπ' + total.toLocaleString() + ' | Received: ‚Çπ' + received.toLocaleString();
            var rows = clientPayments.map(function(p, i) {
                var id = p._id || p.id;
                var isReceived = p.status === 'received';
                var border = isReceived ? 'bg-white border border-emerald-200' : 'bg-gray-50 border-2 border-dashed border-gray-300';
                var circleBg = isReceived ? 'bg-emerald-500' : 'bg-gray-300';
                var circleText = isReceived ? '&#10003;' : String(i + 1);
                var amountColor = isReceived ? 'text-emerald-600' : 'text-gray-400';
                var adminBtns = '<div class="flex gap-2 mt-1 admin-only">' +
                    (!isReceived ? '<button onclick="markPaymentReceived(\'' + id + '\')" class="text-xs text-indigo-600 hover:underline font-medium">Mark Received</button>' : '') +
                    '<button onclick="editClientPaymentRow(\'' + id + '\')" class="text-xs text-blue-500 hover:underline font-medium">Edit</button>' +
                    '<button onclick="deleteClientPayment(\'' + id + '\')" class="text-xs text-red-400 hover:underline font-medium">Delete</button>' +
                    '</div>';
                return '<div id="cpRow-' + id + '" class="flex items-center justify-between p-4 rounded-xl ' + border + '">' +
                    '<div class="flex items-center gap-4">' +
                        '<div class="w-10 h-10 rounded-full ' + circleBg + ' flex items-center justify-center text-white font-bold">' + circleText + '</div>' +
                        '<div>' +
                            '<p class="font-semibold text-gray-800">' + (p.label || 'Payment') + '</p>' +
                            '<p class="text-sm text-gray-400">' + (p.date ? new Date(p.date).toLocaleDateString() : 'Not received') + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="text-right">' +
                        '<p class="text-lg font-bold ' + amountColor + '">‚Çπ' + (p.amount || 0).toLocaleString() + '</p>' +
                        adminBtns +
                    '</div>' +
                '</div>';
            }).join('');
            container.innerHTML = '<div class="flex justify-between items-center p-4 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl mb-4 border border-emerald-200"><span class="font-medium text-emerald-700">Received</span><span class="text-xl font-bold text-emerald-700">‚Çπ' + received.toLocaleString() + ' / ‚Çπ' + total.toLocaleString() + '</span></div><div class="space-y-3">' + rows + '</div>';
        }

        function editClientPaymentRow(id) {
            var p = clientPayments.find(function(x) { return String(x._id || x.id) === String(id); });
            if (!p) return;
            var row = document.getElementById('cpRow-' + id);
            if (!row) return;
            var dateVal = p.date ? p.date.split('T')[0] : '';
            var labelOptions = ['Advance Payment','1st Milestone','2nd Milestone','3rd Milestone','4th Milestone','5th Milestone','Final Payment','Other'].map(function(l) {
                return '<option value="' + l + '"' + (p.label === l ? ' selected' : '') + '>' + l + '</option>';
            }).join('');
            row.innerHTML = '<div class="flex flex-wrap items-center gap-2 w-full">' +
                '<select id="editCpLabel-' + id + '" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400">' + labelOptions + '</select>' +
                '<input type="number" id="editCpAmount-' + id + '" value="' + (p.amount || '') + '" placeholder="Amount" class="w-28 px-3 py-1.5 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400">' +
                '<input type="date" id="editCpDate-' + id + '" value="' + dateVal + '" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-400">' +
                '<button onclick="saveClientPaymentEdit(\'' + id + '\')" class="px-4 py-1.5 bg-emerald-500 text-white rounded-lg text-sm font-semibold hover:bg-emerald-600">Save</button>' +
                '<button onclick="renderClientPayments()" class="px-4 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-200">Cancel</button>' +
            '</div>';
        }

        async function saveClientPaymentEdit(id) {
            var label = document.getElementById('editCpLabel-' + id).value;
            var amount = parseFloat(document.getElementById('editCpAmount-' + id).value);
            var date = document.getElementById('editCpDate-' + id).value;
            if (!amount || !date) { alert('Amount and date are required'); return; }
            try {
                var res = await fetch('/api/payments/client/' + id, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ label: label, amount: amount, date: date })
                });
                var data = await res.json();
                if (data.success) {
                    var p = clientPayments.find(function(x) { return String(x._id || x.id) === String(id); });
                    if (p) { p.label = label; p.amount = amount; p.date = date; }
                    renderClientPayments();
                    addLocalActivity('updated client payment ' + label + ' to ‚Çπ' + amount.toLocaleString(), '‚úèÔ∏è');
                } else { alert(data.error || 'Failed to save'); }
            } catch (err) { alert('Failed to save payment'); }
        }

        async function deleteClientPayment(id) {
            if (!confirm('Delete this payment record?')) return;
            try {
                var res = await fetch('/api/payments/client/' + id, { method: 'DELETE', headers: HEADERS });
                var data = await res.json();
                if (data.success) {
                    clientPayments = clientPayments.filter(function(p) { return String(p._id || p.id) !== String(id); });
                    renderClientPayments();
                } else { alert(data.error || 'Failed to delete'); }
            } catch (err) { alert('Failed to delete payment'); }
        }

        // ==================== RENDER DEV PAYMENTS ====================
        function renderDevPayments() {
            var container = document.getElementById('devPaymentsList');
            if (!container) return;
            var totalPaid = devPayments.reduce(function(s, p) { return s + (p.amount || 0); }, 0);
            if (devPayments.length === 0) {
                container.innerHTML = '<div class="flex justify-between items-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl mb-4 border border-blue-200"><span class="font-medium text-blue-700">Total Paid to Team</span><span class="text-xl font-bold text-blue-700">‚Çπ0</span></div><div class="text-center py-6 text-gray-400 text-sm">No developer payments recorded yet</div>';
                return;
            }
            var rows = devPayments.map(function(p) {
                var id = p._id || p.id;
                var devName = p.developerName || p.developer || 'Unknown';
                return '<div id="dpRow-' + id + '" class="relative pl-12">' +
                    '<div class="absolute left-3 w-4 h-4 rounded-full bg-blue-500 border-4 border-white shadow"></div>' +
                    '<div class="bg-gradient-to-r from-gray-50 to-white rounded-xl p-4 border border-gray-100 hover:shadow-sm transition-all">' +
                        '<div class="flex justify-between items-start">' +
                            '<div>' +
                                '<p class="font-semibold text-gray-800">' + devName + '</p>' +
                                '<p class="text-sm text-gray-400">' + (p.role || '') + (p.note ? ' ‚Ä¢ ' + p.note : '') + '</p>' +
                            '</div>' +
                            '<div class="text-right">' +
                                '<p class="text-lg font-bold text-blue-600">‚Çπ' + (p.amount || 0).toLocaleString() + '</p>' +
                                '<p class="text-xs text-gray-400">' + (p.date ? new Date(p.date).toLocaleDateString() : '') + '</p>' +
                                '<div class="flex gap-2 mt-1 justify-end admin-only">' +
                                    '<button onclick="editDevPaymentRow(\'' + id + '\')" class="text-xs text-blue-500 hover:underline font-medium">Edit</button>' +
                                    '<button onclick="deleteDevPaymentRow(\'' + id + '\')" class="text-xs text-red-400 hover:underline font-medium">Delete</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
            container.innerHTML = '<div class="flex justify-between items-center p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl mb-4 border border-blue-200"><span class="font-medium text-blue-700">Total Paid to Team</span><span class="text-xl font-bold text-blue-700">‚Çπ' + totalPaid.toLocaleString() + '</span></div><div class="relative"><div class="absolute left-5 top-0 bottom-0 w-0.5 bg-gradient-to-b from-blue-400 to-indigo-400"></div><div class="space-y-4" id="devPaymentsRows">' + rows + '</div></div>';
        }

        function editDevPaymentRow(id) {
            var p = devPayments.find(function(x) { return String(x._id || x.id) === String(id); });
            if (!p) return;
            var row = document.getElementById('dpRow-' + id);
            if (!row) return;
            var dateVal = p.date ? new Date(p.date).toISOString().split('T')[0] : '';
            var memberOptions = teamMembers.map(function(m) {
                var isSel = String(p.developer) === String(m._id);
                return '<option value="' + m._id + '"' + (isSel ? ' selected' : '') + '>' + m.name + (m.designation ? ' ‚Äî ' + m.designation : '') + '</option>';
            }).join('');
            row.innerHTML = '<div class="absolute left-3 w-4 h-4 rounded-full bg-blue-500 border-4 border-white shadow"></div>' +
                '<div class="bg-white rounded-xl p-4 border-2 border-blue-300 shadow-sm">' +
                    '<div class="flex flex-wrap items-center gap-2">' +
                        '<select id="editDpDev-' + id + '" class="flex-1 min-w-[160px] px-3 py-1.5 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400">' +
                            '<option value="">Select Member</option>' + memberOptions +
                        '</select>' +
                        '<input type="number" id="editDpAmount-' + id + '" value="' + (p.amount || '') + '" placeholder="Amount" class="w-28 px-3 py-1.5 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400">' +
                        '<input type="date" id="editDpDate-' + id + '" value="' + dateVal + '" class="px-3 py-1.5 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400">' +
                        '<input type="text" id="editDpNote-' + id + '" value="' + (p.note || '') + '" placeholder="Note" class="w-24 px-3 py-1.5 border border-gray-200 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-400">' +
                        '<button onclick="saveDevPaymentEdit(\'' + id + '\')" class="px-4 py-1.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-600">Save</button>' +
                        '<button onclick="renderDevPayments()" class="px-4 py-1.5 bg-gray-100 text-gray-600 rounded-lg text-sm font-semibold hover:bg-gray-200">Cancel</button>' +
                    '</div>' +
                '</div>';
        }

        async function saveDevPaymentEdit(id) {
            var developerId = document.getElementById('editDpDev-' + id).value;
            var amount = parseFloat(document.getElementById('editDpAmount-' + id).value);
            var date = document.getElementById('editDpDate-' + id).value;
            var note = document.getElementById('editDpNote-' + id).value;
            if (!amount || !date) { alert('Amount and date are required'); return; }
            var devMember = teamMembers.find(function(m) { return String(m._id) === String(developerId); });
            try {
                var res = await fetch('/api/payments/developer/' + id, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ developer: developerId || undefined, role: (devMember && (devMember.designation || devMember.role)) || '', amount: amount, date: date, note: note })
                });
                var data = await res.json();
                if (data.success) {
                    var p = devPayments.find(function(x) { return String(x._id || x.id) === String(id); });
                    if (p) {
                        if (developerId && devMember) { p.developer = developerId; p.developerName = devMember.name; p.role = devMember.designation || devMember.role || ''; }
                        p.amount = amount; p.date = date; p.note = note;
                    }
                    renderDevPayments();
                    addLocalActivity('updated developer payment ‚Çπ' + amount.toLocaleString(), '‚úèÔ∏è');
                } else { alert(data.error || 'Failed to save'); }
            } catch (err) { alert('Failed to save payment'); }
        }

        async function deleteDevPaymentRow(id) {
            if (!confirm('Delete this developer payment?')) return;
            try {
                var res = await fetch('/api/payments/developer/' + id, { method: 'DELETE', headers: HEADERS });
                var data = await res.json();
                if (data.success) {
                    devPayments = devPayments.filter(function(p) { return String(p._id || p.id) !== String(id); });
                    renderDevPayments();
                } else { alert(data.error || 'Failed to delete'); }
            } catch (err) { alert('Failed to delete payment'); }
        }

        // ==================== RENDER ACTIVITIES ====================
        function renderActivities() {
            var el = document.getElementById('activityList');
            if (!el) return;
            el.innerHTML = activities.map(function(a) {
                return '<div class="flex gap-4"><div class="w-10 h-10 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center text-lg flex-shrink-0">' + (a.icon || 'üìå') + '</div><div><p class="text-gray-800"><span class="font-semibold">' + a.user + '</span> ' + a.action + '</p><p class="text-xs text-gray-400 mt-1">' + a.time + '</p></div></div>';
            }).join('');
        }

        // ==================== RENDER REMARKS ====================
        function renderRemarks() {
            var el = document.getElementById('remarksList');
            if (!el) return;
            el.innerHTML = remarks.map(function(r) {
                return '<div class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl border border-amber-100"><div class="flex justify-between text-xs mb-2"><span class="font-semibold text-amber-700">' + r.user + '</span><span class="text-amber-500">' + r.time + '</span></div><p class="text-gray-700">' + r.text + '</p></div>';
            }).join('');
        }

        // ==================== API LOADERS ====================
        async function loadProject() {
            try {
                var res = await fetch('/api/projects/' + projectId, { headers: HEADERS });
                var data = await res.json();
                if (data.success && data.data) {
                    project = data.data;

                    // Update header
                    document.getElementById('projectTitle').textContent = project.name || 'Untitled Project';
                    document.getElementById('projectClient').textContent = project.client || 'No Client';

                    var priorityMap = { low: 'Low Priority', medium: 'Medium Priority', high: 'High Priority', critical: 'Critical Priority' };
                    var priorityColors = { low: 'green', medium: 'blue', high: 'orange', critical: 'red' };
                    var p = project.priority || 'medium';
                    var pColor = priorityColors[p] || 'blue';
                    var prEl = document.getElementById('projectPriority');
                    prEl.className = 'px-3 py-1 text-sm font-medium rounded-lg bg-' + pColor + '-100 text-' + pColor + '-700 border border-' + pColor + '-200';
                    prEl.textContent = priorityMap[p] || 'Medium Priority';
                    document.getElementById('projectProgress').textContent = (project.progress || 0) + '% Complete';

                    // Map stages
                    var gradients = ['stage-gradient-1', 'stage-gradient-2', 'stage-gradient-3', 'stage-gradient-4', 'stage-gradient-5', 'stage-gradient-6', 'stage-gradient-7'];
                    stages = (project.stages || []).map(function(s, idx) {
                        return {
                            id: String(s._id || s.id || idx),
                            name: s.name || 'Unknown',
                            status: s.status || 'pending',
                            gradient: s.gradient || gradients[idx % 7],
                            icon: s.icon || 'üìã',
                            assigned: s.assignedName || (s.assigned && s.assigned.name ? s.assigned.name : '') || 'Unassigned',
                            deadline: s.deadline || null,
                            summary: s.summary || '',
                            type: s.type || 'checklist',
                            approved: s.approved || false,
                            items: (s.items || []).map(function(item) {
                                return { id: String(item._id || item.id || Math.random()), text: item.text || 'Item', done: item.done || false };
                            }),
                            repoUrl: s.repoUrl || '',
                            liveUrl: s.liveUrl || '',
                            linkedBackend: s.linkedBackend || '',
                            health: s.health || 'pending',
                            hostingProvider: s.hostingProvider || '',
                            domainUrl: s.domainUrl || '',
                            sslStatus: s.sslStatus || 'pending',
                            deliveries: (s.deliveries || []).map(function(d, di) {
                                return { id: String(d._id || d.id || di), name: d.name || ('Delivery ' + (di + 1)), approved: d.approved || false, date: d.date || null };
                            }),
                            assetRequests: (s.assetRequests || []).map(function(ar) {
                                return { id: String(ar._id || ar.id), label: ar.label || '', type: ar.type || 'other', status: ar.status || 'pending', fileName: ar.fileName || '', fileUrl: ar.fileUrl || '', note: ar.note || '' };
                            })
                        };
                    });

                    console.log('Stages loaded:', stages.length);
                    console.log('Asset requests per stage:', stages.map(function(s) {
                        return { stage: s.name, assetsCount: s.assetRequests?.length || 0, assets: s.assetRequests };
                    }));
                    renderStages();
                }
            } catch (err) {
                console.error('Failed to load project:', err);
                document.getElementById('stagesContainer').innerHTML = '<p class="p-6 text-red-500">Error loading project: ' + err.message + '</p>';
            }
        }

        async function loadTasks() {
            try {
                var res = await fetch('/api/tasks?project=' + projectId, { headers: HEADERS });
                var data = await res.json();
                if (data.success) {
                    tasks = (data.data || []).map(function(t) {
                        return {
                            id: t._id, role: t.role, title: t.title, description: t.description || '',
                            deadline: t.deadline, status: t.status,
                            assignee: t.assigneeName || (t.assignee && t.assignee.name ? t.assignee.name : '') || 'Unassigned',
                            startedAt: t.startedAt || null, completedAt: t.completedAt || null
                        };
                    });
                }
                renderTasks();
            } catch (err) {
                console.error('Failed to load tasks:', err);
                renderTasks();
            }
        }

        async function loadActivities() {
            try {
                var res = await fetch('/api/projects/' + projectId + '/activities', { headers: HEADERS });
                var data = await res.json();
                if (data.success && data.data) {
                    activities = data.data.map(function(a) {
                        return { user: a.userName || (a.user && a.user.name ? a.user.name : 'System'), action: a.action, time: formatTimeAgo(a.createdAt), icon: a.icon || 'üìå' };
                    });
                } else { activities = []; }
            } catch (err) { activities = []; }
            renderActivities();
        }

        async function loadPayments() {
            try {
                var cpRes = await fetch('/api/payments/client/' + projectId, { headers: HEADERS });
                var cpData = await cpRes.json();
                clientPayments = (cpData.success && cpData.data) ? cpData.data : [];
            } catch (err) { clientPayments = []; }

            try {
                var dpRes = await fetch('/api/payments/developer/project/' + projectId, { headers: HEADERS });
                var dpData = await dpRes.json();
                devPayments = (dpData.success && dpData.data) ? dpData.data : [];
            } catch (err) { devPayments = []; }

            renderClientPayments();
            renderDevPayments();
        }

        async function loadRemarks() {
            try {
                var res = await fetch('/api/projects/' + projectId + '/remarks', { headers: HEADERS });
                var data = await res.json();
                if (data.success && data.data) {
                    remarks = data.data.map(function(r) {
                        return { user: r.userName || (r.user && r.user.name ? r.user.name : 'Anonymous'), text: r.text || r.content, time: formatTimeAgo(r.createdAt) };
                    });
                } else { remarks = []; }
            } catch (err) { remarks = []; }
            renderRemarks();
        }

        // ==================== STAGE ACTIONS ====================
        async function toggleChecklistItem(stageId, itemId) {
            var stage = stages.find(function(s) { return s.id === stageId; });
            if (!stage) return;
            var item = stage.items.find(function(i) { return i.id === itemId; });
            if (!item) return;
            item.done = !item.done;
            renderStages();

            try {
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId + '/items/' + itemId, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ done: item.done })
                });
                if (res.ok) {
                    addLocalActivity((item.done ? 'completed' : 'unchecked') + ' "' + item.text + '"', item.done ? '‚úÖ' : '‚è™');
                } else { item.done = !item.done; renderStages(); }
            } catch (err) { item.done = !item.done; renderStages(); }
        }

        async function approveStage(stageId) {
            var stage = stages.find(function(s) { return s.id === stageId; });
            if (!stage) return;
            try {
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ approved: true, status: 'completed' })
                });
                if (res.ok) {
                    stage.approved = true;
                    stage.status = 'completed';
                    renderStages();
                    addLocalActivity('approved ' + stage.name + ' stage', '‚úÖ');
                }
            } catch (err) { console.error('Failed to approve stage:', err); }
        }

        async function saveLinks(stageId) {
            var stage = stages.find(function(s) { return s.id === stageId; });
            if (!stage) return;
            var repoUrl = document.getElementById('repo-' + stageId).value;
            var liveUrl = document.getElementById('live-' + stageId).value;
            if (!repoUrl && !liveUrl) {
                alert('Please enter at least one URL (Repository or Live)');
                return;
            }
            try {
                var newStatus = stage.status === 'pending' ? 'in-progress' : stage.status;
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ repoUrl: repoUrl, liveUrl: liveUrl, health: liveUrl ? 'success' : 'pending', status: newStatus })
                });
                var data = await res.json();
                if (res.ok) {
                    stage.repoUrl = repoUrl; stage.liveUrl = liveUrl;
                    stage.status = newStatus;
                    if (liveUrl) stage.health = 'success';
                    renderStages();
                    addLocalActivity('updated ' + stage.name + ' URLs', 'üîó');
                    alert('Links saved successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save links'));
                    console.error('API Error:', data);
                }
            } catch (err) { 
                alert('Failed to save links: ' + err.message);
                console.error('Error:', err);
            }
        }

        async function markReady(stageId) {
            console.log('üîµ markReady called with stageId:', stageId, 'Type:', typeof stageId);
            var stage = stages.find(function(s) { return s.id === stageId; });
            if (!stage) {
                console.error('‚ùå Stage not found in local array. Available stages:', stages.map(s => ({ name: s.name, id: s.id })));
                return;
            }
            console.log('‚úÖ Found stage:', stage.name, 'Current status:', stage.status);
            if (!TOKEN) {
                alert('‚ùå Session expired! Please login again.');
                window.location.href = '/login';
                return;
            }
            try {
                console.log('üöÄ Sending API call - Project:', projectId, 'Stage:', stageId, 'Payload: { status: completed, health: success }');
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ status: 'completed', health: 'success' })
                });
                console.log('üì® API Response Status:', res.status, 'OK?:', res.ok);
                var data = await res.json();
                console.log('üì• API Response Data:', data);
                if (res.ok) {
                    stage.status = 'completed'; stage.health = 'success';
                    console.log('‚úèÔ∏è Local stage updated:', { name: stage.name, status: stage.status, health: stage.health });
                    renderStages();
                    addLocalActivity('marked ' + stage.name + ' as ready', 'üöÄ');
                    alert('‚úÖ Stage marked as ready!');
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to mark stage as ready'));
                    console.error('API Error:', data);
                }
            } catch (err) { 
                alert('‚ùå Failed to mark as ready: ' + err.message);
                console.error('Error:', err);
            }
        }

        async function saveHosting(stageId) {
            var stage = stages.find(function(s) { return s.id === stageId; });
            if (!stage) return;
            var hostingProvider = document.getElementById('hosting-' + stageId).value;
            var domainUrl = document.getElementById('domain-' + stageId).value;
            var sslStatus = document.getElementById('ssl-' + stageId).checked ? 'active' : 'pending';
            console.log('Saving hosting - Provider:', hostingProvider, 'Domain:', domainUrl, 'SSL:', sslStatus);
            try {
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ hostingProvider: hostingProvider, domainUrl: domainUrl, sslStatus: sslStatus, status: 'in-progress' })
                });
                var data = await res.json();
                console.log('saveHosting response:', res.status, data);
                if (res.ok) {
                    stage.hostingProvider = hostingProvider; stage.domainUrl = domainUrl; stage.sslStatus = sslStatus;
                    stage.status = 'in-progress';
                    renderStages();
                    addLocalActivity('updated hosting configuration', '‚òÅÔ∏è');
                    alert('‚úÖ Hosting details saved!');
                } else {
                    alert('‚ùå Error: ' + (data.error || 'Failed to save hosting details'));
                    console.error('API Error:', data);
                }
            } catch (err) { 
                alert('‚ùå Failed to save hosting details: ' + err.message);
                console.error('Error:', err);
            }
        }

        async function toggleDelivery(stageId, deliveryId) {
            var stage = stages.find(function(s) { return s.id === stageId; });
            if (!stage) return;
            var delivery = stage.deliveries.find(function(d) { return d.id === deliveryId; });
            if (!delivery) return;
            delivery.approved = !delivery.approved;
            if (delivery.approved) delivery.date = new Date().toLocaleDateString();
            renderStages();
            try {
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ deliveries: stage.deliveries })
                });
                if (res.ok) {
                    addLocalActivity((delivery.approved ? 'approved' : 'unapproved') + ' ' + delivery.name, delivery.approved ? '‚úÖ' : '‚è™');
                } else { delivery.approved = !delivery.approved; renderStages(); }
            } catch (err) { delivery.approved = !delivery.approved; renderStages(); }
        }

        // ==================== TASK ACTIONS ====================
        function updateDeveloperDropdown() {
            var selectedRole = document.getElementById('taskRole').value;
            var devDropdown = document.getElementById('taskDeveloper');
            devDropdown.innerHTML = '<option value="">Select Developer</option>';
            if (!selectedRole || !project || !project.team) return;

            var teamMembers = project.team.filter(function(m) { return m.role === selectedRole; });
            if (teamMembers.length === 0) {
                devDropdown.innerHTML = '<option value="">No developers with this role</option>';
                return;
            }
            teamMembers.forEach(function(member) {
                var opt = document.createElement('option');
                opt.value = (typeof member.user === 'object' && member.user) ? member.user._id : member.user;
                opt.textContent = member.name;
                devDropdown.appendChild(opt);
            });
        }

        async function addTask() {
            var role = document.getElementById('taskRole').value;
            var developerId = document.getElementById('taskDeveloper').value;
            var devDropdown = document.getElementById('taskDeveloper');
            var developerName = devDropdown.options[devDropdown.selectedIndex].text;
            var title = document.getElementById('taskTitle').value;
            var deadline = document.getElementById('taskDeadline').value;
            var description = document.getElementById('taskDescription').value;
            if (!role || !developerId || !title || !deadline) { alert('Please fill role, developer, title, and deadline'); return; }

            try {
                var res = await fetch('/api/tasks', {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify({ project: projectId, title: title, description: description, role: role, assignee: developerId, deadline: deadline })
                });
                var data = await res.json();
                if (data.success) {
                    document.getElementById('taskRole').value = '';
                    document.getElementById('taskDeveloper').innerHTML = '<option value="">Select Developer</option>';
                    document.getElementById('taskTitle').value = '';
                    document.getElementById('taskDeadline').value = '';
                    document.getElementById('taskDescription').value = '';
                    await loadTasks();
                    addLocalActivity('assigned task "' + title + '" to ' + (developerName || role), 'üìù');
                } else { alert(data.error || 'Failed to create task'); }
            } catch (err) { alert('Failed to create task: ' + err.message); }
        }

        async function startTaskAPI(taskId) {
            try {
                var res = await fetch('/api/tasks/' + taskId + '/start', { method: 'PUT', headers: HEADERS });
                var data = await res.json();
                if (data.success) {
                    await loadTasks();
                    var task = tasks.find(function(t) { return t.id === taskId; });
                    addLocalActivity('started "' + (task ? task.title : 'task') + '"', '‚ñ∂Ô∏è');
                } else { alert(data.error || 'Failed to start task'); }
            } catch (err) { alert('Failed to start task'); }
        }

        async function completeTaskAPI(taskId) {
            try {
                var res = await fetch('/api/tasks/' + taskId + '/complete', { method: 'PUT', headers: HEADERS });
                var data = await res.json();
                if (data.success) {
                    await loadTasks();
                    var task = tasks.find(function(t) { return t.id === taskId; });
                    addLocalActivity('completed "' + (task ? task.title : 'task') + '"', '‚úÖ');
                } else { alert(data.error || 'Failed to complete task'); }
            } catch (err) { alert('Failed to complete task'); }
        }

        // ==================== PAYMENT / REMARK ACTIONS ====================
        async function addClientPayment() {
            var label = document.getElementById('newPaymentLabel').value || 'Payment';
            var amount = parseFloat(document.getElementById('newPaymentAmount').value);
            var date = document.getElementById('newPaymentDate').value;
            if (!amount || !date) { alert('Enter amount and date'); return; }
            try {
                var res = await fetch('/api/payments/client', {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify({ project: projectId, projectName: (project && project.name) || '', label: label, amount: amount, date: date })
                });
                var data = await res.json();
                if (data.success) {
                    document.getElementById('newPaymentAmount').value = '';
                    document.getElementById('newPaymentDate').value = '';
                    await loadPayments();
                    addLocalActivity('added client payment ' + label + ' ‚Çπ' + amount.toLocaleString(), 'üí∞');
                } else { alert(data.error || 'Failed to add payment'); }
            } catch (err) { alert('Failed to add payment'); }
        }

        async function markPaymentReceived(id) {
            var payment = clientPayments.find(function(p) { return String(p._id || p.id) === String(id); });
            if (!payment) return;
            try {
                var res = await fetch('/api/payments/client/' + id, {
                    method: 'PUT', headers: HEADERS,
                    body: JSON.stringify({ status: 'received', date: new Date().toISOString().split('T')[0] })
                });
                var data = await res.json();
                if (data.success) {
                    payment.status = 'received';
                    payment.date = data.data.date || new Date().toISOString().split('T')[0];
                    renderClientPayments();
                    addLocalActivity('marked ' + (payment.label || 'payment') + ' as received', 'üí∞');
                } else {
                    alert('Error updating payment: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Failed to update payment');
            }
        }

        async function addDevPayment() {
            var developerId = document.getElementById('devPaymentRole').value;
            var amount = parseFloat(document.getElementById('devPaymentAmount').value);
            var date = document.getElementById('devPaymentDate').value;
            if (!developerId || !amount || !date) { alert('Fill all fields'); return; }
            var devMember = teamMembers.find(function(m) { return m._id === developerId; });
            try {
                var res = await fetch('/api/payments/developer', {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify({ project: projectId, developer: developerId, role: (devMember && (devMember.designation || devMember.role)) || '', amount: amount, date: date, note: 'Payment' })
                });
                var data = await res.json();
                if (data.success) {
                    document.getElementById('devPaymentRole').value = '';
                    document.getElementById('devPaymentAmount').value = '';
                    document.getElementById('devPaymentDate').value = '';
                    await loadPayments();
                    addLocalActivity('paid ‚Çπ' + amount.toLocaleString() + ' to ' + (devMember ? devMember.name : 'developer'), 'üí∏');
                } else { alert(data.error || 'Failed to add payment'); }
            } catch (err) { alert('Failed to add payment'); }
        }

        async function loadTeamMembers() {
            try {
                var res = await fetch('/api/users', { headers: HEADERS });
                var data = await res.json();
                teamMembers = (data.success && data.data) ? data.data : [];
                var sel = document.getElementById('devPaymentRole');
                if (!sel) return;
                sel.innerHTML = '<option value="">Select Team Member...</option>' +
                    teamMembers.map(function(m) {
                        var label = m.designation || m.role || '';
                        return '<option value="' + m._id + '">' + m.name + (label ? ' ‚Äî ' + label : '') + '</option>';
                    }).join('');
            } catch (err) { /* silently fail */ }
        }

        async function generatePaymentSchedule() {
            if (!project || !project.totalAmount || project.totalAmount <= 0) {
                alert('No total amount set for this project. Please update the project with totalAmount first.');
                return;
            }
            if (!confirm('Generate payment schedule based on project settings?\n\nTotal: ‚Çπ' + project.totalAmount.toLocaleString() + '\nAdvance: ' + (project.advancePercent || 25) + '%\nMilestones: ' + (project.milestones || 3))) return;
            try {
                var res = await fetch('/api/payments/client/generate/' + projectId, {
                    method: 'POST', headers: HEADERS
                });
                var data = await res.json();
                if (data.success) {
                    await loadPayments();
                    addLocalActivity('generated payment schedule', 'üí≥');
                } else {
                    alert(data.error || 'Failed to generate');
                }
            } catch (err) { alert('Failed to generate payment schedule'); }
        }

        function addRemark() {
            var text = document.getElementById('remarkInput').value.trim();
            if (!text) return;
            remarks.unshift({ user: USER.name || 'User', text: text, time: 'Just now' });
            document.getElementById('remarkInput').value = '';
            renderRemarks();
            addLocalActivity('added a remark', 'üí¨');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login?logout=true';
        }

        // ==================== ASSET REQUESTS ====================
        function toggleAssetForm(stageId) {
            var form = document.getElementById('assetForm-' + stageId);
            if (form) form.classList.toggle('hidden');
        }

        async function addAssetRequest(stageId) {
            var label = document.getElementById('assetLabel-' + stageId).value.trim();
            if (!label) { alert('Please enter asset name'); return; }
            var type = document.getElementById('assetType-' + stageId).value;
            var note = document.getElementById('assetNote-' + stageId).value.trim();
            try {
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId + '/asset-requests', {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify({ label: label, type: type, note: note })
                });
                var data = await res.json();
                if (data.success) {
                    showToast('Asset request sent!', 'success');
                    await loadProject();
                    renderAssetsTab();
                } else {
                    showToast(data.error || 'Failed to add request', 'error');
                }
            } catch(e) {
                showToast('Error adding asset request', 'error');
            }
        }

        // ==================== ASSETS TAB ====================
        var currentAssetFilter = 'all';

        function getAllAssets() {
            var all = [];
            console.log('getAllAssets called with stages:', stages.length, stages);
            stages.forEach(function(stage) {
                console.log('Stage:', stage.name, 'assetRequests:', stage.assetRequests);
                (stage.assetRequests || []).forEach(function(ar) {
                    all.push({
                        stageId: stage.id,
                        stageName: stage.name,
                        stageIcon: stage.icon,
                        assetId: ar.id,
                        label: ar.label,
                        type: ar.type || 'other',
                        status: ar.status || 'pending',
                        fileName: ar.fileName || '',
                        fileUrl: ar.fileUrl || '',
                        note: ar.note || ''
                    });
                });
            });
            console.log('getAllAssets returning:', all);
            return all;
        }

        function renderAssetsTab() {
            var allAssets = getAllAssets();
            console.log('renderAssetsTab called - All assets:', allAssets);
            var pending = allAssets.filter(function(a) { return a.status === 'pending'; });
            var received = allAssets.filter(function(a) { return a.status === 'received'; });

            document.getElementById('assetTotalCount').textContent = allAssets.length;
            document.getElementById('assetPendingCount').textContent = pending.length;
            document.getElementById('assetReceivedCount').textContent = received.length;

            // Populate stage dropdown
            var stageSelect = document.getElementById('globalAssetStage');
            if (stageSelect) {
                stageSelect.innerHTML = '';
                stages.forEach(function(s) {
                    stageSelect.innerHTML += '<option value="' + s.id + '">' + s.name + '</option>';
                });
            }

            // Filter
            var filtered = allAssets;
            if (currentAssetFilter === 'pending') filtered = pending;
            else if (currentAssetFilter === 'received') filtered = received;

            var container = document.getElementById('assetsTabList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center py-16">' +
                    '<svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>' +
                    '<p class="text-gray-400 font-medium">No asset requests' + (currentAssetFilter !== 'all' ? ' with status "' + currentAssetFilter + '"' : '') + '</p>' +
                    '<p class="text-gray-300 text-sm mt-1">Send an asset request to the client using the form above</p>' +
                '</div>';
                return;
            }

            var html = '';
            var typeIcons = {
                logo: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',
                content: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
                'brand-guide': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/></svg>',
                'api-keys': '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>',
                approval: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                other: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>'
            };
            var typeBg = {
                logo: 'bg-pink-100 text-pink-600',
                content: 'bg-sky-100 text-sky-600',
                'brand-guide': 'bg-violet-100 text-violet-600',
                'api-keys': 'bg-orange-100 text-orange-600',
                approval: 'bg-emerald-100 text-emerald-600',
                other: 'bg-gray-100 text-gray-600'
            };

            filtered.forEach(function(a) {
                var statusBadge = a.status === 'received'
                    ? '<span class="px-2.5 py-1 text-xs font-bold rounded-lg bg-emerald-100 text-emerald-700">Received</span>'
                    : a.status === 'rejected'
                    ? '<span class="px-2.5 py-1 text-xs font-bold rounded-lg bg-red-100 text-red-700">Rejected</span>'
                    : '<span class="px-2.5 py-1 text-xs font-bold rounded-lg bg-amber-100 text-amber-700">Pending</span>';

                var fileSection = '';
                if (a.status === 'received' && a.fileUrl) {
                    fileSection = '<a href="' + a.fileUrl + '" target="_blank" download="' + (a.fileName || 'asset') + '" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">' +
                        '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>' +
                        (a.fileName || 'Download') + '</a>';
                } else if (a.status === 'received' && !a.fileUrl) {
                    fileSection = '<span class="text-xs text-gray-400 italic">Marked done (no file)</span>';
                }

                html += '<div class="asset-item flex items-center justify-between p-5 hover:bg-gray-50 transition-colors" data-status="' + a.status + '">' +
                    '<div class="flex items-center gap-4 flex-1 min-w-0">' +
                        '<div class="w-10 h-10 rounded-xl ' + (typeBg[a.type] || typeBg.other) + ' flex items-center justify-center flex-shrink-0">' +
                            (typeIcons[a.type] || typeIcons.other) +
                        '</div>' +
                        '<div class="min-w-0 flex-1">' +
                            '<div class="flex items-center gap-2 flex-wrap">' +
                                '<p class="font-semibold text-gray-900 text-sm">' + a.label + '</p>' +
                                statusBadge +
                            '</div>' +
                            '<div class="flex items-center gap-3 mt-1">' +
                                '<span class="text-xs text-gray-400">' + a.stageName + '</span>' +
                                '<span class="text-xs text-gray-300">|</span>' +
                                '<span class="text-xs text-gray-400 capitalize">' + a.type.replace('-', ' ') + '</span>' +
                                (a.note ? '<span class="text-xs text-gray-300">|</span><span class="text-xs text-gray-500">' + a.note + '</span>' : '') +
                            '</div>' +
                            (fileSection ? '<div class="mt-2">' + fileSection + '</div>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="flex items-center gap-2 ml-4 flex-shrink-0">' +
                        '<button onclick="deleteAssetRequest(\'' + a.stageId + '\', \'' + a.assetId + '\', \'' + a.label.replace(/'/g, "\\'") + '\')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Delete">' +
                            '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>' +
                        '</button>' +
                    '</div>' +
                '</div>';
            });

            container.innerHTML = html;
        }

        function filterAssets(filter) {
            currentAssetFilter = filter;
            document.querySelectorAll('.asset-filter-btn').forEach(function(btn) {
                if (btn.dataset.filter === filter) {
                    btn.className = 'asset-filter-btn active px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-900 text-white';
                } else {
                    btn.className = 'asset-filter-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200';
                }
            });
            renderAssetsTab();
        }

        async function sendGlobalAssetRequest() {
            var stageId = document.getElementById('globalAssetStage').value;
            var label = document.getElementById('globalAssetLabel').value.trim();
            if (!stageId) { showToast('Please select a stage', 'error'); return; }
            if (!label) { showToast('Please enter asset name', 'error'); return; }
            var type = document.getElementById('globalAssetType').value;
            var note = document.getElementById('globalAssetNote').value.trim();
            try {
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId + '/asset-requests', {
                    method: 'POST', headers: HEADERS,
                    body: JSON.stringify({ label: label, type: type, note: note })
                });
                var data = await res.json();
                if (data.success) {
                    showToast('Asset request sent to client!', 'success');
                    document.getElementById('globalAssetLabel').value = '';
                    document.getElementById('globalAssetNote').value = '';
                    await loadProject();
                    renderAssetsTab();
                } else {
                    showToast(data.error || 'Failed to send request', 'error');
                }
            } catch(e) {
                showToast('Error sending asset request', 'error');
            }
        }

        async function deleteAssetRequest(stageId, assetId, label) {
            if (!confirm('Delete asset request "' + label + '"? This will also delete any uploaded file.')) return;
            try {
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId + '/asset-requests/' + assetId, {
                    method: 'DELETE', headers: HEADERS
                });
                var data = await res.json();
                if (data.success) {
                    showToast('Asset request deleted', 'success');
                    await loadProject();
                    renderAssetsTab();
                } else {
                    showToast(data.error || 'Failed to delete', 'error');
                }
            } catch(e) {
                showToast('Error deleting asset request', 'error');
            }
        }

        // ==================== MEETINGS ====================
        function showToast(message, type) {
            type = type || 'info';
            var toast = document.createElement('div');
            var colors = { info: 'bg-blue-600', success: 'bg-emerald-600', error: 'bg-red-600' };
            toast.className = 'fixed bottom-4 right-4 ' + (colors[type] || colors.info) + ' text-white px-6 py-3 rounded-xl shadow-2xl z-50 font-medium text-sm';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(function() { toast.remove(); }, 300); }, 3000);
        }

        async function loadMeetings() {
            try {
                var res = await api.getMeetings(projectId);
                var meetings = res.data || [];
                var grid = document.getElementById('meetingsList');
                if (meetings.length === 0) {
                    grid.innerHTML = '<div class="text-center py-16"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><p class="text-gray-400 font-medium">No meetings scheduled</p><p class="text-gray-300 text-sm mt-1">Schedule a meeting above to get started</p></div>';
                    return;
                }
                var colors = ['from-blue-600 to-blue-800', 'from-indigo-600 to-indigo-800', 'from-violet-600 to-violet-800', 'from-emerald-600 to-emerald-800'];
                grid.innerHTML = meetings.map(function(m, i) {
                    var dt = new Date(m.scheduledAt);
                    var isPast = dt < new Date();
                    var statusBadge = m.status === 'completed' ? '<span class="px-2.5 py-1 text-xs font-bold bg-emerald-100 text-emerald-700 rounded-lg">Completed</span>' :
                        isPast ? '<span class="px-2.5 py-1 text-xs font-bold bg-gray-100 text-gray-600 rounded-lg">Past</span>' :
                        '<span class="px-2.5 py-1 text-xs font-bold bg-blue-100 text-blue-700 rounded-lg">Scheduled</span>';

                    return '<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">' +
                        '<div class="h-1.5 bg-gradient-to-r ' + colors[i % colors.length] + '"></div>' +
                        '<div class="p-5">' +
                            '<div class="flex items-center justify-between mb-3">' +
                                '<h4 class="font-bold text-gray-900">' + m.title + '</h4>' +
                                '<div class="flex items-center gap-2">' +
                                    statusBadge +
                                    '<span class="px-2.5 py-1 text-xs font-bold bg-gray-50 text-gray-600 rounded-lg">' + (m.type || 'google-meet') + '</span>' +
                                '</div>' +
                            '</div>' +
                            '<div class="flex items-center gap-2 text-sm text-gray-500 mb-2">' +
                                '<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' +
                                '<span>' + dt.toLocaleString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'}) + '</span>' +
                                '<span class="text-gray-300">|</span>' +
                                '<span>' + (m.duration || 30) + ' min</span>' +
                            '</div>' +
                            (m.stage ? '<span class="inline-block px-2 py-0.5 text-xs font-medium bg-indigo-50 text-indigo-700 rounded mb-2">' + m.stage + '</span>' : '') +
                            (m.agenda ? '<p class="text-xs text-gray-500 bg-gray-50 rounded-lg p-3 mt-2 mb-3">' + m.agenda + '</p>' : '') +
                            '<div class="flex items-center gap-2 mt-3">' +
                                (m.meetingLink ? '<a href="' + m.meetingLink + '" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg> Join</a>' : '') +
                                (m.meetingLink ? '<button onclick="copyMeetingLink(\'' + m.meetingLink + '\')" class="inline-flex items-center gap-1 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy Link</button>' : '') +
                                '<button onclick="editMeeting(\'' + m._id + '\',\'' + (m.title || '').replace(/'/g, "\\'") + '\',\'' + (m.type || 'google-meet') + '\',\'' + (m.meetingLink || '').replace(/'/g, "\\'") + '\',\'' + (m.scheduledAt || '') + '\',' + (m.duration || 30) + ',\'' + (m.stage || '').replace(/'/g, "\\'") + '\',\'' + (m.agenda || '').replace(/'/g, "\\'") + '\')" class="inline-flex items-center gap-1 px-3 py-2 text-indigo-600 hover:bg-indigo-50 rounded-lg text-sm font-medium transition-colors admin-only"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg> Edit</button>' +
                                '<button onclick="deleteMeeting(\'' + m._id + '\')" class="inline-flex items-center gap-1 px-3 py-2 text-red-500 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors admin-only"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg> Delete</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch(e) {
                document.getElementById('meetingsList').innerHTML = '<div class="text-center py-12"><p class="text-red-400 font-medium">Error loading meetings</p></div>';
            }
        }

        async function scheduleMeeting() {
            var title = document.getElementById('mtgTitle').value.trim();
            var scheduledAt = document.getElementById('mtgDate').value;
            if (!title || !scheduledAt) { alert('Please enter meeting title and date/time'); return; }

            var meetingData = {
                project: projectId,
                title: title,
                type: document.getElementById('mtgType').value,
                meetingLink: document.getElementById('mtgLink').value.trim(),
                scheduledAt: new Date(scheduledAt).toISOString(),
                duration: parseInt(document.getElementById('mtgDuration').value) || 30,
                stage: document.getElementById('mtgStage').value,
                agenda: document.getElementById('mtgAgenda').value.trim()
            };

            try {
                if (editingMeetingId) {
                    await api.updateMeeting(editingMeetingId, meetingData);
                    showToast('Meeting updated!', 'success');
                    cancelEditMeeting();
                } else {
                    await api.createMeeting(meetingData);
                    showToast('Meeting scheduled!', 'success');
                }
                document.getElementById('mtgTitle').value = '';
                document.getElementById('mtgLink').value = '';
                document.getElementById('mtgDate').value = '';
                document.getElementById('mtgAgenda').value = '';
                document.getElementById('mtgDuration').value = '30';
                await loadMeetings();
            } catch(e) {
                showToast('Error: ' + e.message, 'error');
            }
        }

        function editMeeting(id, title, type, link, scheduledAt, duration, stage, agenda) {
            editingMeetingId = id;
            document.getElementById('mtgTitle').value = title || '';
            document.getElementById('mtgType').value = type || 'google-meet';
            document.getElementById('mtgLink').value = link || '';
            if (scheduledAt) {
                var dt = new Date(scheduledAt);
                var local = new Date(dt.getTime() - dt.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                document.getElementById('mtgDate').value = local;
            }
            document.getElementById('mtgDuration').value = duration || 30;
            document.getElementById('mtgStage').value = stage || '';
            document.getElementById('mtgAgenda').value = agenda || '';

            // Update button text and show cancel
            var btn = document.querySelector('#tab-meetings button[onclick="scheduleMeeting()"]');
            if (btn) btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Update Meeting';
            // Add cancel button if not exists
            if (!document.getElementById('cancelEditMtgBtn')) {
                var cancelBtn = document.createElement('button');
                cancelBtn.id = 'cancelEditMtgBtn';
                cancelBtn.className = 'px-4 py-2.5 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-all ml-2';
                cancelBtn.textContent = 'Cancel';
                cancelBtn.onclick = cancelEditMeeting;
                btn.parentNode.insertBefore(cancelBtn, btn.nextSibling);
            }
            // Scroll to form
            document.getElementById('mtgTitle').scrollIntoView({ behavior: 'smooth', block: 'center' });
            document.getElementById('mtgTitle').focus();
        }

        function cancelEditMeeting() {
            editingMeetingId = null;
            document.getElementById('mtgTitle').value = '';
            document.getElementById('mtgLink').value = '';
            document.getElementById('mtgDate').value = '';
            document.getElementById('mtgAgenda').value = '';
            document.getElementById('mtgDuration').value = '30';
            var btn = document.querySelector('#tab-meetings button[onclick="scheduleMeeting()"]');
            if (btn) btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Schedule Meeting';
            var cancelBtn = document.getElementById('cancelEditMtgBtn');
            if (cancelBtn) cancelBtn.remove();
        }

        async function deleteMeeting(id) {
            if (!confirm('Delete this meeting?')) return;
            try {
                await api.deleteMeeting(id);
                showToast('Meeting deleted', 'success');
                await loadMeetings();
            } catch(e) {
                showToast('Error deleting meeting', 'error');
            }
        }

        function copyMeetingLink(link) {
            navigator.clipboard.writeText(link).then(function() {
                showToast('Meeting link copied!', 'success');
            }).catch(function() {
                prompt('Copy this meeting link:', link);
            });
        }

        // ==================== INIT ====================
        async function init() {
            if (!TOKEN || !USER.name) { window.location.href = '/login'; return; }

            document.getElementById('userName').textContent = USER.name;
            document.getElementById('userInitials').textContent = USER.name.split(' ').map(function(n) { return n[0]; }).join('');

            if (USER.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(function(el) { el.style.display = 'none'; });
            }
            if (USER.role === 'developer') {
                document.querySelectorAll('.admin-subadmin-only').forEach(function(el) { el.style.display = 'none'; });
            }

            if (!projectId) {
                document.getElementById('stagesContainer').innerHTML = '<p class="p-6 text-red-500">No project ID provided in URL.</p>';
                return;
            }

            await loadProject();
            await loadTasks();
            await loadActivities();
            await loadPayments();
            await loadRemarks();
            await loadTeamMembers();
            await loadMeetings();

            // populate meeting stage dropdown
            if (project && project.stages) {
                var mtgStageEl = document.getElementById('mtgStage');
                if (mtgStageEl) {
                    project.stages.forEach(function(s) {
                        var opt = document.createElement('option');
                        opt.value = s.name;
                        opt.textContent = s.name;
                        mtgStageEl.appendChild(opt);
                    });
                }
            }
        }

        init();
    </script>
</body>
</html>
