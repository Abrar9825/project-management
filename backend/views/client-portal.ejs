<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Portal | Agency Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50:'#f0f7ff',100:'#e0effe',200:'#bae0fd',300:'#7ccbfc',400:'#36b3f8',500:'#0c96e9',600:'#0077c7',700:'#005fa1',800:'#005085',900:'#00436e' },
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .gradient-hero { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 40%, #3b7daa 70%, #4a9fd4 100%); }
        .tab-active { background: linear-gradient(135deg, #1e3a5f, #3b7daa); color: white !important; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 15px rgba(30,58,95,0.3); }
        .tab-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-btn:hover:not(.tab-active) { background: #f0f4f8; color: #1e3a5f; }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-3px); box-shadow: 0 16px 40px rgba(0,0,0,0.08); }
        .progress-ring-bg { stroke: #e2e8f0; }
        .progress-ring-fill { stroke-linecap: round; transition: stroke-dashoffset 1s ease; }
        .feedback-star { cursor: pointer; transition: all 0.2s; }
        .feedback-star:hover, .feedback-star.active { color: #f59e0b; transform: scale(1.3); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="glass border-b border-gray-200/50 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 gradient-hero rounded-xl flex items-center justify-center shadow-md">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                    <div>
                        <span class="text-lg font-bold text-gray-900">Client Portal</span>
                        <p class="text-[10px] text-gray-400 -mt-0.5 tracking-wider uppercase">Project Dashboard</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-xl">
                        <div class="w-7 h-7 rounded-full bg-gradient-to-r from-blue-600 to-blue-800 flex items-center justify-center text-white text-xs font-bold" id="clientAvatar">?</div>
                        <span class="text-sm font-medium text-gray-700" id="clientName">Welcome</span>
                    </div>
                    <button onclick="logout()" class="p-2.5 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Project Header -->
        <div class="gradient-hero rounded-2xl p-8 mb-8 text-white relative overflow-hidden">
            <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/3"></div>
            <div class="absolute bottom-0 left-1/4 w-48 h-48 bg-white/5 rounded-full translate-y-1/2"></div>
            
            <div class="relative z-10">
                <div class="flex items-start justify-between flex-wrap gap-4 mb-6">
                    <div>
                        <p class="text-white/50 text-xs font-semibold uppercase tracking-widest mb-1">Project</p>
                        <h1 class="text-3xl sm:text-4xl font-extrabold mb-1 tracking-tight" id="projectName">Loading...</h1>
                        <p class="text-white/60 text-sm max-w-xl" id="projectDesc">Loading project details...</p>
                    </div>
                    <div class="flex items-center gap-2 px-4 py-2 bg-white/10 rounded-xl backdrop-blur-sm border border-white/10">
                        <span class="text-white/60 text-sm">Status</span>
                        <span class="font-bold text-lg" id="projectMode">--</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/10">
                        <p class="text-white/50 text-xs font-semibold uppercase tracking-wider mb-2">Progress</p>
                        <div class="flex items-end gap-2">
                            <span class="text-3xl font-extrabold" id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-white/20 rounded-full h-2 mt-3">
                            <div class="bg-white rounded-full h-2 transition-all duration-1000" id="progressBar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/10">
                        <p class="text-white/50 text-xs font-semibold uppercase tracking-wider mb-2">Current Stage</p>
                        <p class="font-bold text-lg leading-tight" id="currentStage">--</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/10">
                        <p class="text-white/50 text-xs font-semibold uppercase tracking-wider mb-2">Due Date</p>
                        <p class="font-bold text-lg" id="dueDate">--</p>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 backdrop-blur-sm border border-white/10">
                        <p class="text-white/50 text-xs font-semibold uppercase tracking-wider mb-2">Stages Done</p>
                        <p class="font-bold text-lg" id="stagesDone">0 / 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        <div id="alertsSection" class="space-y-3 mb-6"></div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-8 overflow-x-auto pb-2">
            <button onclick="switchTab('stages')" class="tab-btn portal-tab px-5 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap rounded-xl tab-active" data-tab="stages">Stages</button>
            <button onclick="switchTab('payments')" class="tab-btn portal-tab px-5 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap rounded-xl hide-for-subadmin" data-tab="payments">Payments</button>
            <button onclick="switchTab('documents')" class="tab-btn portal-tab px-5 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap rounded-xl hide-for-subadmin" data-tab="documents">Documents</button>
            <button onclick="switchTab('meetings')" class="tab-btn portal-tab px-5 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap rounded-xl" data-tab="meetings">Meetings</button>
            <button onclick="switchTab('reports')" class="tab-btn portal-tab px-5 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap rounded-xl" data-tab="reports">Reports</button>
            <button onclick="switchTab('feedback')" class="tab-btn portal-tab px-5 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap rounded-xl" data-tab="feedback">Feedback</button>
            <button onclick="switchTab('assets')" class="tab-btn portal-tab px-5 py-2.5 text-sm font-medium text-gray-500 whitespace-nowrap rounded-xl" data-tab="assets">Assets</button>
        </div>

        <!-- Tab Content -->
        <!-- Stages Tab -->
        <div id="tab-stages" class="tab-content">
            <div id="stagesGrid"></div>
        </div>

        <!-- Payments Tab -->
        <div id="tab-payments" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8" id="paymentStats"></div>
            <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100">
                    <h3 class="font-bold text-gray-900">Payment Schedule</h3>
                </div>
                <table class="min-w-full" id="paymentTableWrap">
                    <thead><tr class="bg-gray-50"><th class="px-6 py-3.5 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Payment</th><th class="px-6 py-3.5 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Amount</th><th class="px-6 py-3.5 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Due Date</th><th class="px-6 py-3.5 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th></tr></thead>
                    <tbody id="paymentTable"></tbody>
                </table>
                <div id="paymentEmpty" class="hidden text-center py-12 px-6">
                    <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <p class="text-gray-400 font-medium">No payment records set up yet</p>
                    <p class="text-gray-400 text-sm mt-1">Payment schedule will appear here once configured</p>
                </div>
            </div>
        </div>

        <!-- Documents Tab -->
        <div id="tab-documents" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="clientDocsGrid">
                <div class="text-center text-gray-400 py-12 col-span-full">Loading documents...</div>
            </div>
        </div>

        <!-- Meetings Tab -->
        <div id="tab-meetings" class="tab-content hidden">
            <div class="space-y-4" id="meetingsGrid">
                <div class="text-center text-gray-400 py-12">Loading meetings...</div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="tab-reports" class="tab-content hidden">
            <div class="space-y-4" id="reportsGrid">
                <div class="text-center text-gray-400 py-12">Loading reports...</div>
            </div>
        </div>

        <!-- Feedback Tab -->
        <div id="tab-feedback" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Submit Feedback -->
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900">Share Your Feedback</h3>
                        <p class="text-xs text-gray-500">Your opinion helps us improve</p>
                    </div>
                    <div class="p-6">
                    <form id="feedbackForm" onsubmit="submitFeedback(event)">
                        <div class="space-y-5">
                            <div>
                                <label class="text-sm font-semibold text-gray-700 mb-1.5 block">Stage (optional)</label>
                                <select id="fbStage" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-200 focus:border-blue-400 outline-none transition-all">
                                    <option value="">General Feedback</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-700 mb-2 block">Overall Rating</label>
                                <div class="flex gap-2" id="ratingStars">
                                    <span class="feedback-star text-3xl text-gray-300" onclick="setRating(1)">&#9733;</span>
                                    <span class="feedback-star text-3xl text-gray-300" onclick="setRating(2)">&#9733;</span>
                                    <span class="feedback-star text-3xl text-gray-300" onclick="setRating(3)">&#9733;</span>
                                    <span class="feedback-star text-3xl text-gray-300" onclick="setRating(4)">&#9733;</span>
                                    <span class="feedback-star text-3xl text-gray-300" onclick="setRating(5)">&#9733;</span>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs font-semibold text-gray-600 mb-1 block">Communication</label>
                                    <select id="fbComm" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-200 outline-none"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-600 mb-1 block">Quality</label>
                                    <select id="fbQuality" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-200 outline-none"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
                                </div>
                                <div>
                                    <label class="text-xs font-semibold text-gray-600 mb-1 block">Timeliness</label>
                                    <select id="fbTime" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-200 outline-none"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option></select>
                                </div>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-700 mb-1.5 block">Comments</label>
                                <textarea id="fbComments" rows="3" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Share your experience..."></textarea>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-700 mb-1.5 block">Suggestions</label>
                                <textarea id="fbSuggestions" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-200 outline-none" placeholder="Any suggestions for improvement..."></textarea>
                            </div>
                            <button type="submit" class="w-full py-3 bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-xl font-semibold hover:shadow-lg transition-all">Submit Feedback</button>
                        </div>
                    </form>
                    </div>
                </div>

                <!-- Previous Feedbacks -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Previous Feedback</h3>
                    <div class="space-y-4" id="feedbackList">
                        <div class="text-center text-gray-400 py-12">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assets Tab -->
        <div id="tab-assets" class="tab-content hidden">
            <div class="grid grid-cols-1 gap-5">
                <div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900">Requested Assets</h3>
                        <p class="text-xs text-gray-500">Items the team needs from you to continue work</p>
                    </div>
                    <div class="p-6">
                    <div class="space-y-3" id="assetsList">
                        <div class="text-center text-gray-400 py-12">Loading...</div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script>
        let projectId = new URLSearchParams(window.location.search).get('id');
        let clientData = null;
        let feedbackRating = 0;

        async function init() {
            if (!projectId) { alert('No project ID provided'); return; }
            await loadClientView();
            await loadClientDocuments();
            await loadMeetings();
            await loadReports();
            await loadFeedback();
        }

        async function loadClientView() {
            try {
                const res = await api.fetch(`/projects/${projectId}/client-view`);
                clientData = res.data;
                renderClientView();
            } catch(e) {
                document.getElementById('projectName').textContent = 'Error loading project';
            }
        }

        // Stage type icons (SVG)
        function getStageIcon(type) {
            if (type === 'checklist') return '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>';
            if (type === 'development') return '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>';
            if (type === 'hosting') return '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/></svg>';
            if (type === 'delivery') return '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>';
            if (type === 'maintenance') return '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>';
            return '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>';
        }

        // Brief description for each stage name/type to display in client portal
        function getStageDescription(name, type) {
            var n = (name || '').toLowerCase();
            if (n.includes('requirement')) return 'Gathering and documenting project requirements, scope, and specifications.';
            if (n.includes('design') || n.includes('ui') || n.includes('ux')) return 'Creating visual designs, wireframes, and user interface prototypes.';
            if (n.includes('frontend') || n.includes('front-end') || n.includes('front end')) return 'Building the client-facing interface and user experience.';
            if (n.includes('backend') || n.includes('back-end') || n.includes('back end')) return 'Developing server-side logic, APIs, and database architecture.';
            if (n.includes('qa') || n.includes('test') || n.includes('quality')) return 'Testing the application for bugs, performance, and quality assurance.';
            if (n.includes('hosting') || n.includes('deploy')) return 'Deploying the application to production servers and configuring infrastructure.';
            if (n.includes('delivery') || n.includes('handover') || n.includes('launch')) return 'Final handover, documentation, and project delivery to client.';
            if (n.includes('maintenance') || n.includes('support')) return 'Ongoing maintenance, updates, and technical support.';
            if (type === 'checklist') return 'Tracking key milestones and checklist items for this phase.';
            if (type === 'development') return 'Active development and coding work for this module.';
            if (type === 'hosting') return 'Server setup, deployment, and infrastructure configuration.';
            if (type === 'delivery') return 'Project handover and final delivery.';
            return 'Project phase in progress.';
        }

        // Stage card color schemes
        const stageColors = [
            { gradient: 'from-blue-500 to-blue-700', border: 'border-blue-200', text: 'text-blue-700', bar: 'from-blue-400 to-blue-600' },
            { gradient: 'from-violet-500 to-violet-700', border: 'border-violet-200', text: 'text-violet-700', bar: 'from-violet-400 to-violet-600' },
            { gradient: 'from-emerald-500 to-emerald-700', border: 'border-emerald-200', text: 'text-emerald-700', bar: 'from-emerald-400 to-emerald-600' },
            { gradient: 'from-amber-500 to-amber-700', border: 'border-amber-200', text: 'text-amber-700', bar: 'from-amber-400 to-amber-600' },
            { gradient: 'from-rose-500 to-rose-700', border: 'border-rose-200', text: 'text-rose-700', bar: 'from-rose-400 to-rose-600' },
            { gradient: 'from-cyan-500 to-cyan-700', border: 'border-cyan-200', text: 'text-cyan-700', bar: 'from-cyan-400 to-cyan-600' },
            { gradient: 'from-indigo-500 to-indigo-700', border: 'border-indigo-200', text: 'text-indigo-700', bar: 'from-indigo-400 to-indigo-600' },
            { gradient: 'from-teal-500 to-teal-700', border: 'border-teal-200', text: 'text-teal-700', bar: 'from-teal-400 to-teal-600' },
        ];

        function renderClientView() {
            const d = clientData;
            const clientNameStr = d.client || 'Client';
            document.getElementById('clientName').textContent = clientNameStr;
            document.getElementById('clientAvatar').textContent = clientNameStr.charAt(0).toUpperCase();
            document.getElementById('projectName').textContent = d.projectName;
            document.getElementById('progressBar').style.width = d.progress + '%';
            document.getElementById('progressPercent').textContent = d.progress + '%';
            document.getElementById('currentStage').textContent = d.currentStage || '--';

            const modeMap = { active: 'Active', paused: 'Paused', maintenance: 'Maintenance', completed: 'Completed' };
            document.getElementById('projectMode').textContent = modeMap[d.mode] || d.mode || '--';
            document.getElementById('dueDate').textContent = d.dueDate ? new Date(d.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '--';

            const totalS = (d.phases || []).length;
            const doneS = (d.phases || []).filter(s => s.status === 'completed').length;
            document.getElementById('stagesDone').textContent = doneS + ' / ' + totalS;

            // Alerts
            const alerts = document.getElementById('alertsSection');
            let alertHtml = '';
            if (d.isPaused) alertHtml += '<div class="flex items-center gap-3 bg-amber-50 border border-amber-200 p-4 rounded-xl"><svg class="w-5 h-5 text-amber-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg><p class="text-amber-800 font-medium text-sm">Project is currently on hold. Please check payment status.</p></div>';
            if (d.payments.isOverdue) alertHtml += '<div class="flex items-center gap-3 bg-red-50 border border-red-200 p-4 rounded-xl"><svg class="w-5 h-5 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg><p class="text-red-800 font-medium text-sm">' + d.payments.overdueCount + ' payment(s) overdue. Please make the payment to resume work.</p></div>';
            if (d.pendingFromClient.length > 0) alertHtml += '<div class="flex items-center gap-3 bg-blue-50 border border-blue-200 p-4 rounded-xl"><svg class="w-5 h-5 text-blue-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg><p class="text-blue-800 font-medium text-sm">' + d.pendingFromClient.length + ' asset(s) requested. Please upload them in the Assets tab.</p></div>';
            alerts.innerHTML = alertHtml;

            // ========== STAGES - Card Grid ==========
            const stagesGrid = document.getElementById('stagesGrid');
            if (d.phases && d.phases.length > 0) {
                const totalStages = d.phases.length;
                const completedStages = d.phases.filter(s => s.status === 'completed').length;
                const inProgressStages = d.phases.filter(s => s.status === 'in-progress').length;
                const pendingStages = totalStages - completedStages - inProgressStages;
                const progressPct = Math.round((completedStages / totalStages) * 100);

                let html = '';

                // Overview bar
                html += '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 mb-6">' +
                    '<div class="flex flex-col sm:flex-row items-center gap-6">' +
                        '<div class="relative flex-shrink-0">' +
                            '<svg width="90" height="90" viewBox="0 0 100 100" class="transform -rotate-90">' +
                                '<circle cx="50" cy="50" r="42" fill="none" stroke-width="8" class="progress-ring-bg"/>' +
                                '<circle cx="50" cy="50" r="42" fill="none" stroke-width="8" stroke="url(#cpGrad)" class="progress-ring-fill" stroke-dasharray="' + (2 * Math.PI * 42) + '" stroke-dashoffset="' + (2 * Math.PI * 42 * (1 - progressPct / 100)) + '"/>' +
                                '<defs><linearGradient id="cpGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#1e3a5f"/><stop offset="100%" style="stop-color:#3b7daa"/></linearGradient></defs>' +
                            '</svg>' +
                            '<div class="absolute inset-0 flex items-center justify-center">' +
                                '<span class="text-xl font-extrabold text-gray-900">' + progressPct + '%</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex-1 text-center sm:text-left">' +
                            '<h3 class="text-xl font-bold text-gray-900">Project Progress</h3>' +
                            '<p class="text-gray-500 text-sm mt-1">' + completedStages + ' of ' + totalStages + ' stages completed</p>' +
                            '<div class="flex flex-wrap gap-4 mt-3 justify-center sm:justify-start">' +
                                '<span class="flex items-center gap-1.5 text-xs font-semibold text-emerald-600"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span> Completed: ' + completedStages + '</span>' +
                                '<span class="flex items-center gap-1.5 text-xs font-semibold text-blue-600"><span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> In Progress: ' + inProgressStages + '</span>' +
                                '<span class="flex items-center gap-1.5 text-xs font-semibold text-gray-500"><span class="w-2.5 h-2.5 rounded-full bg-gray-300"></span> Pending: ' + pendingStages + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';

                // Stage Cards Grid
                html += '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">';
                d.phases.forEach(function(s, idx) {
                    var color = stageColors[idx % stageColors.length];
                    var isCompleted = s.status === 'completed';
                    var isActive = s.status === 'in-progress';

                    // Status indicator
                    var statusHtml = '';
                    if (isCompleted) {
                        statusHtml = '<span class="inline-flex items-center gap-1.5 px-3 py-1 text-xs font-bold rounded-full bg-emerald-100 text-emerald-700">Completed</span>';
                    } else if (isActive) {
                        statusHtml = '<span class="inline-flex items-center gap-1.5 px-3 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-700">In Progress</span>';
                    } else {
                        statusHtml = '<span class="inline-flex items-center gap-1.5 px-3 py-1 text-xs font-bold rounded-full bg-gray-100 text-gray-500">Pending</span>';
                    }

                    // Card content / details
                    var detailsHtml = '';

                    // Brief stage description
                    var desc = getStageDescription(s.name, s.type);
                    detailsHtml += '<p class="text-xs text-gray-400 mt-1 leading-relaxed">' + desc + '</p>';

                    // Checklist
                    if (s.type === 'checklist') {
                        var rate = s.completionRate || 0;
                        detailsHtml += '<div class="mt-3">' +
                            '<div class="flex justify-between text-xs font-medium mb-1.5"><span class="text-gray-500">Checklist Progress</span><span class="' + color.text + ' font-bold">' + rate + '%</span></div>' +
                            '<div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-gradient-to-r ' + color.bar + ' rounded-full h-2 transition-all" style="width:' + rate + '%"></div></div>' +
                            (s.totalItems > 0 ? '<p class="text-xs text-gray-400 mt-1.5">' + s.doneItems + ' of ' + s.totalItems + ' items done</p>' : '') +
                        '</div>';

                        // Requirement doc link
                        if (s.requirementDocUrl && s.name.toLowerCase().includes('requirement')) {
                            detailsHtml += '<a href="' + s.requirementDocUrl + '" target="_blank" class="mt-3 inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 border border-blue-200 text-blue-700 rounded-lg text-xs font-medium hover:bg-blue-100 transition-colors">' +
                                '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>' +
                                'View Requirement Document</a>';
                        }

                        // Figma link for Design stages
                        if (s.figmaUrl && s.name.toLowerCase().includes('design')) {
                            detailsHtml += '<a href="' + s.figmaUrl + '" target="_blank" class="mt-3 inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-50 border border-purple-200 text-purple-700 rounded-lg text-xs font-medium hover:bg-purple-100 transition-colors">' +
                                '<svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M8 24c2.2 0 4-1.8 4-4v-4H8c-2.2 0-4 1.8-4 4s1.8 4 4 4zm0-20C5.8 4 4 5.8 4 8s1.8 4 4 4h4V4H8zm0 0h4v8H8c-2.2 0-4-1.8-4-4s1.8-4 4-4zm8 0c-2.2 0-4 1.8-4 4s1.8 4 4 4h4V4h-4zm0 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4z"/></svg>' +
                                'View Design in Figma</a>';
                        }
                    }

                    // Development
                    if (s.type === 'development') {
                        var links = '';
                        if (s.liveUrl) links += '<a href="' + s.liveUrl + '" target="_blank" class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg text-xs font-medium hover:bg-blue-700 transition-colors"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></svg> Live Preview</a>';
                        if (links) detailsHtml += '<div class="flex flex-wrap gap-2 mt-3">' + links + '</div>';
                        if (s.health === 'success') detailsHtml += '<div class="mt-3 flex items-center gap-2 px-3 py-2 bg-emerald-50 rounded-lg border border-emerald-200"><span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span><span class="text-xs font-semibold text-emerald-700">System Online</span></div>';
                    }

                    // Hosting
                    if (s.type === 'hosting') {
                        var chips = '';
                        if (s.hostingProvider) chips += '<span class="px-2.5 py-1 bg-violet-50 border border-violet-200 text-violet-700 text-xs font-semibold rounded-lg">' + s.hostingProvider.toUpperCase() + '</span>';
                        if (s.sslStatus === 'active') chips += '<span class="px-2.5 py-1 bg-emerald-50 border border-emerald-200 text-emerald-700 text-xs font-semibold rounded-lg">SSL Active</span>';
                        if (s.domainUrl) chips += '<a href="' + s.domainUrl + '" target="_blank" class="px-2.5 py-1 bg-blue-50 border border-blue-200 text-blue-700 text-xs font-semibold rounded-lg hover:bg-blue-100 transition-colors">' + s.domainUrl.replace('https://', '').replace('http://', '') + '</a>';
                        if (chips) detailsHtml += '<div class="flex flex-wrap gap-2 mt-3">' + chips + '</div>';
                        if (s.clientLiveUrl) {
                            detailsHtml += '<a href="' + s.clientLiveUrl + '" target="_blank" class="mt-3 inline-flex items-center gap-1.5 px-3 py-1.5 bg-emerald-50 border border-emerald-200 text-emerald-700 rounded-lg text-xs font-medium hover:bg-emerald-100 transition-colors">' +
                                '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></svg>' +
                                'Visit Live Website</a>';
                        }
                    }

                    // Card border style
                    var cardBorder = isCompleted ? 'border-emerald-200' : isActive ? color.border : 'border-gray-200';
                    var topBar = isCompleted ? 'from-emerald-400 to-emerald-600' : isActive ? color.bar : 'from-gray-200 to-gray-300';

                    html += '<div class="bg-white rounded-2xl border ' + cardBorder + ' shadow-sm card-hover overflow-hidden flex flex-col">' +
                        '<div class="h-1.5 bg-gradient-to-r ' + topBar + '"></div>' +
                        '<div class="p-5 flex-1 flex flex-col">' +
                            '<div class="flex items-start justify-between gap-3 mb-3">' +
                                '<div class="w-11 h-11 rounded-xl bg-gradient-to-br ' + (isCompleted ? 'from-emerald-500 to-emerald-700' : isActive ? color.gradient : 'from-gray-300 to-gray-400') + ' flex items-center justify-center text-white flex-shrink-0">' +
                                    (isCompleted ? '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>' : getStageIcon(s.type)) +
                                '</div>' +
                                statusHtml +
                            '</div>' +
                            '<h3 class="font-bold text-gray-900 text-base mb-1">' + s.name + '</h3>' +
                            (s.deadline ? '<p class="text-xs text-gray-400 mb-1">Due: ' + new Date(s.deadline).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) + '</p>' : '') +
                            '<div class="flex-1">' + detailsHtml + '</div>' +
                        '</div>' +
                    '</div>';
                });
                html += '</div>';
                stagesGrid.innerHTML = html;
            } else {
                stagesGrid.innerHTML = '<div class="text-center py-16"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg><p class="text-gray-400 font-medium">No visible stages</p></div>';
            }

            // ========== PAYMENTS ==========
            var ps = d.payments;
            var paidPercent = ps.total > 0 ? Math.round((ps.received / ps.total) * 100) : 0;
            document.getElementById('paymentStats').innerHTML =
                '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 card-hover">' +
                    '<div class="flex items-center gap-4">' +
                        '<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center shadow-md">' +
                            '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
                        '</div>' +
                        '<div>' +
                            '<p class="text-sm text-gray-500 font-medium">Total Project Value</p>' +
                            '<p class="text-2xl font-extrabold text-gray-900">\u20B9' + (ps.total || 0).toLocaleString() + '</p>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 card-hover">' +
                    '<div class="flex items-center gap-4">' +
                        '<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-700 flex items-center justify-center shadow-md">' +
                            '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
                        '</div>' +
                        '<div>' +
                            '<p class="text-sm text-gray-500 font-medium">Amount Paid</p>' +
                            '<p class="text-2xl font-extrabold text-emerald-600">\u20B9' + (ps.received || 0).toLocaleString() + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mt-4">' +
                        '<div class="flex justify-between text-xs text-gray-500 font-medium mb-1.5"><span>Payment Progress</span><span class="text-emerald-600 font-bold">' + paidPercent + '%</span></div>' +
                        '<div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-gradient-to-r from-emerald-400 to-emerald-600 rounded-full h-2 transition-all" style="width:' + paidPercent + '%"></div></div>' +
                    '</div>' +
                '</div>' +
                '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 card-hover">' +
                    '<div class="flex items-center gap-4">' +
                        '<div class="w-12 h-12 rounded-xl bg-gradient-to-br ' + (ps.isOverdue ? 'from-red-500 to-red-700' : 'from-amber-500 to-amber-700') + ' flex items-center justify-center shadow-md">' +
                            '<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
                        '</div>' +
                        '<div>' +
                            '<p class="text-sm text-gray-500 font-medium">' + (ps.isOverdue ? 'Overdue Amount' : 'Remaining') + '</p>' +
                            '<p class="text-2xl font-extrabold ' + (ps.isOverdue ? 'text-red-600' : 'text-amber-600') + '">\u20B9' + (ps.pending || 0).toLocaleString() + '</p>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            
            // Payment table
            var details = ps.details || [];
            var paymentEmpty = document.getElementById('paymentEmpty');
            var paymentTableWrap = document.getElementById('paymentTableWrap');
            var paymentTable = document.getElementById('paymentTable');
            if (details.length === 0) {
                paymentTableWrap.classList.add('hidden');
                paymentEmpty.classList.remove('hidden');
            } else {
                paymentTableWrap.classList.remove('hidden');
                paymentEmpty.classList.add('hidden');
                paymentTable.innerHTML = details.map(function(p, idx) {
                    var isReceived = p.status === 'received';
                    var statusClasses = isReceived ? 'bg-emerald-100 text-emerald-700' : p.status === 'pending' ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600';
                    var statusText = isReceived ? 'Received' : p.status === 'pending' ? 'Pending' : (p.status || 'Unknown');
                    var rowBg = isReceived ? 'bg-emerald-50/30' : '';
                    return '<tr class="border-b border-gray-50 hover:bg-gray-50/50 transition-colors ' + rowBg + '">' +
                        '<td class="px-6 py-4"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg ' + (isReceived ? 'bg-emerald-500' : 'bg-gray-200') + ' flex items-center justify-center text-white text-xs font-bold">' + (isReceived ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>' : (idx + 1)) + '</div><span class="font-semibold text-gray-900 text-sm">' + p.label + '</span></div></td>' +
                        '<td class="px-6 py-4 font-bold text-gray-900">\u20B9' + (p.amount || 0).toLocaleString() + '</td>' +
                        '<td class="px-6 py-4 text-sm text-gray-500">' + (p.date ? new Date(p.date).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : '--') + '</td>' +
                        '<td class="px-6 py-4"><span class="px-3 py-1.5 text-xs font-bold rounded-full ' + statusClasses + '">' + statusText + '</span></td>' +
                    '</tr>';
                }).join('');
            }

            // Populate feedback stage select
            var fbStage = document.getElementById('fbStage');
            if (d.phases) {
                d.phases.forEach(function(s) {
                    var opt = document.createElement('option');
                    opt.value = s.name;
                    opt.textContent = s.name;
                    fbStage.appendChild(opt);
                });
            }

            // Assets
            var assetsList = document.getElementById('assetsList');
            var allAssets = (d.pendingFromClient || []).concat(d.completedByClient || []);
            if (allAssets.length === 0) {
                assetsList.innerHTML = '<div class="text-center py-8"><svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg><p class="text-gray-400 font-medium">No asset requests at this time</p></div>';
            } else {
                assetsList.innerHTML = '';
                (d.pendingFromClient || []).forEach(function(a) {
                    assetsList.innerHTML += '<div class="flex items-center justify-between p-4 bg-amber-50 rounded-xl border border-amber-200">' +
                        '<div class="flex items-center gap-3">' +
                            '<div class="w-9 h-9 rounded-lg bg-amber-100 flex items-center justify-center">' +
                                '<svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>' +
                            '</div>' +
                            '<div>' +
                                '<p class="font-semibold text-gray-900 text-sm">' + a.label + '</p>' +
                                '<p class="text-xs text-gray-500">Stage: ' + a.stageName + ' &middot; Type: ' + (a.type || 'other') + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-2">' +
                            '<label class="px-3 py-1.5 text-xs font-bold bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer">' +
                                '<input type="file" class="hidden" onchange="uploadAssetFile(\'' + a.stageId + '\', \'' + a.assetId + '\', this)">' +
                                'Upload File' +
                            '</label>' +
                            '<button onclick="markAssetUploaded(\'' + a.stageId + '\', \'' + a.assetId + '\')" class="px-3 py-1.5 text-xs font-bold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Mark Done</button>' +
                            '<span class="px-3 py-1.5 text-xs font-bold bg-amber-200 text-amber-800 rounded-lg">Pending</span>' +
                        '</div>' +
                    '</div>';
                });
                (d.completedByClient || []).forEach(function(a) {
                    var downloadBtn = '';
                    if (a.fileUrl) {
                        downloadBtn = '<a href="' + a.fileUrl + '" download="' + (a.fileName || 'asset') + '" class="px-3 py-1.5 text-xs font-bold bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center gap-1">' +
                            '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>' +
                            'Download</a>';
                    }
                    assetsList.innerHTML += '<div class="flex items-center justify-between p-4 bg-emerald-50 rounded-xl border border-emerald-200">' +
                        '<div class="flex items-center gap-3">' +
                            '<div class="w-9 h-9 rounded-lg bg-emerald-100 flex items-center justify-center">' +
                                '<svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
                            '</div>' +
                            '<div>' +
                                '<p class="font-semibold text-gray-900 text-sm">' + a.label + (a.fileName ? ' â€” ' + a.fileName : '') + '</p>' +
                                '<p class="text-xs text-gray-500">Stage: ' + a.stageName + '</p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="flex items-center gap-2">' + downloadBtn +
                        '<span class="px-3 py-1.5 text-xs font-bold bg-emerald-200 text-emerald-800 rounded-lg">Received</span>' +
                        '</div>' +
                    '</div>';
                });
            }
        }

        async function loadClientDocuments() {
            try {
                var res = await api.getClientDocuments(projectId);
                var docs = res.data || [];
                var grid = document.getElementById('clientDocsGrid');
                if (docs.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center py-16"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg><p class="text-gray-400 font-medium">No documents shared yet</p></div>';
                    return;
                }
                var docColors = [
                    'from-blue-500 to-blue-700',
                    'from-violet-500 to-violet-700',
                    'from-emerald-500 to-emerald-700',
                    'from-rose-500 to-rose-700',
                    'from-amber-500 to-amber-700',
                    'from-cyan-500 to-cyan-700',
                ];
                grid.innerHTML = docs.map(function(doc, i) {
                    return '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 card-hover cursor-pointer group" onclick="viewClientDoc(\'' + doc._id + '\')">' +
                        '<div class="w-11 h-11 rounded-xl bg-gradient-to-br ' + docColors[i % docColors.length] + ' flex items-center justify-center mb-4 shadow-md group-hover:scale-110 transition-transform">' +
                            '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>' +
                        '</div>' +
                        '<h4 class="font-bold text-gray-900 mb-1 text-sm line-clamp-2">' + doc.title + '</h4>' +
                        '<p class="text-xs text-gray-400">' + new Date(doc.createdAt).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) + '</p>' +
                    '</div>';
                }).join('');
            } catch(e) {
                document.getElementById('clientDocsGrid').innerHTML = '<div class="col-span-full text-center py-12"><p class="text-red-400 font-medium">Error loading documents</p></div>';
            }
        }

        async function loadMeetings() {
            try {
                var res = await api.getMeetings(projectId);
                var meetings = res.data || [];
                var grid = document.getElementById('meetingsGrid');
                if (meetings.length === 0) {
                    grid.innerHTML = '<div class="text-center py-16"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><p class="text-gray-400 font-medium">No meetings scheduled</p></div>';
                    return;
                }
                var mtgColors = ['from-blue-500 to-blue-700', 'from-violet-500 to-violet-700', 'from-rose-500 to-rose-700', 'from-emerald-500 to-emerald-700'];
                grid.innerHTML = meetings.map(function(m, i) {
                    var dt = new Date(m.scheduledAt);
                    var isPast = dt < new Date();
                    var statusLabel = m.status === 'completed' ? '<span class="px-3 py-1 text-xs font-bold bg-emerald-100 text-emerald-700 rounded-lg">Completed</span>' :
                        isPast ? '<span class="px-3 py-1 text-xs font-bold bg-gray-100 text-gray-500 rounded-lg">Past</span>' :
                        '<span class="px-3 py-1 text-xs font-bold bg-blue-100 text-blue-700 rounded-lg">Upcoming</span>';

                    return '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden card-hover">' +
                        '<div class="h-1.5 bg-gradient-to-r ' + mtgColors[i % mtgColors.length] + '"></div>' +
                        '<div class="p-5">' +
                            '<div class="flex items-center justify-between mb-3">' +
                                '<h4 class="font-bold text-gray-900">' + m.title + '</h4>' +
                                '<div class="flex items-center gap-2">' +
                                    statusLabel +
                                    '<span class="px-3 py-1 text-xs font-bold bg-gray-50 text-gray-600 rounded-lg">' + (m.type || 'google-meet') + '</span>' +
                                '</div>' +
                            '</div>' +
                            '<div class="flex items-center gap-2 text-sm text-gray-500 mb-2">' +
                                '<svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>' +
                                '<span>' + dt.toLocaleString('en-US', {weekday:'short', month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'}) + '</span>' +
                                '<span class="text-gray-300">|</span>' +
                                '<span>' + (m.duration || 30) + ' min</span>' +
                            '</div>' +
                            (m.stage ? '<span class="inline-block px-2 py-0.5 text-xs font-medium bg-indigo-50 text-indigo-700 rounded mb-2">' + m.stage + '</span>' : '') +
                            (m.meetingLink && !isPast ? '<a href="' + m.meetingLink + '" target="_blank" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors mt-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg> Join Meeting</a>' : '') +
                            (m.agenda ? '<p class="text-xs text-gray-400 mt-3 bg-gray-50 rounded-lg p-3">' + m.agenda + '</p>' : '') +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch(e) {
                document.getElementById('meetingsGrid').innerHTML = '<div class="text-center py-12"><p class="text-red-400 font-medium">Error loading meetings</p></div>';
            }
        }

        async function loadReports() {
            try {
                var res = await api.getClientDocuments(projectId);
                var allDocs = res.data || [];
                var reports = allDocs.filter(function(d) { return d.type === 'monthly-report' || d.type === 'tracking-sheet' || d.type === 'stage-summary'; });
                var grid = document.getElementById('reportsGrid');
                if (reports.length === 0) {
                    grid.innerHTML = '<div class="text-center py-16"><svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg><p class="text-gray-400 font-medium">No reports available yet</p></div>';
                    return;
                }
                var rptColors = ['from-indigo-500 to-indigo-700', 'from-violet-500 to-violet-700', 'from-blue-500 to-blue-700', 'from-emerald-500 to-emerald-700'];
                grid.innerHTML = reports.map(function(doc, i) {
                    var typeLabel = doc.type === 'monthly-report' ? 'Monthly Report' : doc.type === 'tracking-sheet' ? 'Tracking Sheet' : 'Stage Summary';
                    return '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden card-hover">' +
                        '<div class="h-1.5 bg-gradient-to-r ' + rptColors[i % rptColors.length] + '"></div>' +
                        '<div class="p-5">' +
                            '<div class="flex items-center justify-between mb-3">' +
                                '<h4 class="font-bold text-gray-900 text-sm line-clamp-2">' + doc.title + '</h4>' +
                                '<span class="px-3 py-1 text-xs font-bold bg-indigo-50 text-indigo-700 rounded-lg flex-shrink-0 ml-2">' + typeLabel + '</span>' +
                            '</div>' +
                            '<p class="text-xs text-gray-400 mb-3">' + new Date(doc.createdAt).toLocaleDateString('en-US', {month:'long', day:'numeric', year:'numeric'}) + '</p>' +
                            '<button onclick="viewClientDoc(\'' + doc._id + '\')" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors">' +
                                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>' +
                                'View Report</button>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch(e) {
                document.getElementById('reportsGrid').innerHTML = '<div class="text-center py-12"><p class="text-red-400 font-medium">Error loading reports</p></div>';
            }
        }

        async function loadFeedback() {
            try {
                var res = await api.getFeedback(projectId);
                var feedbacks = res.data || [];
                var list = document.getElementById('feedbackList');
                if (feedbacks.length === 0) {
                    list.innerHTML = '<div class="text-center py-12"><svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg><p class="text-gray-400 font-medium">No feedback submitted yet</p></div>';
                    return;
                }
                list.innerHTML = feedbacks.map(function(f) {
                    var stars = '';
                    for (var i = 0; i < 5; i++) stars += i < f.rating ? '&#9733;' : '&#9734;';
                    return '<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5 card-hover">' +
                        '<div class="flex items-center justify-between mb-3">' +
                            '<span class="text-yellow-400 text-lg">' + stars + '</span>' +
                            '<span class="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded-lg">' + new Date(f.createdAt).toLocaleDateString() + '</span>' +
                        '</div>' +
                        (f.stage ? '<span class="inline-block px-2.5 py-1 text-xs font-bold bg-blue-50 text-blue-700 rounded-lg border border-blue-100 mb-2">' + f.stage + ' Stage</span>' : '') +
                        '<p class="text-sm text-gray-700 mb-2">' + (f.comments || 'No comments') + '</p>' +
                        (f.response ? '<div class="bg-blue-50 rounded-xl p-4 mt-3 border border-blue-100"><p class="text-xs font-bold text-blue-700 mb-1">Team Response:</p><p class="text-sm text-gray-700">' + f.response.text + '</p></div>' : '') +
                    '</div>';
                }).join('');
            } catch(e) {
                document.getElementById('feedbackList').innerHTML = '<div class="text-center py-8"><p class="text-red-400 font-medium">Error loading feedback</p></div>';
            }
        }

        function setRating(val) {
            feedbackRating = val;
            var stars = document.querySelectorAll('#ratingStars .feedback-star');
            for (var i = 0; i < stars.length; i++) {
                if (i < val) {
                    stars[i].classList.add('active');
                    stars[i].style.color = '#f59e0b';
                } else {
                    stars[i].classList.remove('active');
                    stars[i].style.color = '#d1d5db';
                }
            }
        }

        async function submitFeedback(e) {
            e.preventDefault();
            if (feedbackRating === 0) { alert('Please select a rating'); return; }
            try {
                await api.submitFeedback({
                    project: projectId,
                    stage: document.getElementById('fbStage').value,
                    type: document.getElementById('fbStage').value ? 'stage-completion' : 'general',
                    rating: feedbackRating,
                    communication: parseInt(document.getElementById('fbComm').value),
                    quality: parseInt(document.getElementById('fbQuality').value),
                    timeliness: parseInt(document.getElementById('fbTime').value),
                    comments: document.getElementById('fbComments').value,
                    suggestions: document.getElementById('fbSuggestions').value
                });
                showToast('Feedback submitted successfully!', 'success');
                document.getElementById('feedbackForm').reset();
                feedbackRating = 0;
                setRating(0);
                await loadFeedback();
            } catch(e) {
                showToast('Error submitting feedback', 'error');
            }
        }

        async function viewClientDoc(docId) {
            try {
                var res = await api.fetch('/documents/' + docId);
                var doc = res.data;
                var printWindow = window.open('', '_blank');
                var content;
                try { content = JSON.parse(doc.content); } catch(e) { content = null; }
                
                var cName = clientData ? clientData.client : '';
                var pName = clientData ? clientData.projectName : (doc.projectName || '');

                // Build clean formatted body
                var bodyHtml = '';
                if (!content) {
                    bodyHtml = '<pre style="white-space:pre-wrap;font-family:inherit;">' + (doc.content || '') + '</pre>';
                } else if (!content.sections) {
                    bodyHtml = '<pre style="white-space:pre-wrap;font-family:inherit;">' + JSON.stringify(content, null, 2) + '</pre>';
                } else {
                    bodyHtml = clientRenderSections(content.sections, 0);
                }

                printWindow.document.write('<html><head><title>' + doc.title + '</title>' +
                '<style>' +
                '@page { margin: 20mm 15mm; size: A4; }' +
                'body{font-family:"Segoe UI",Tahoma,sans-serif;max-width:780px;margin:0 auto;padding:30px 20px;color:#1a1a2e;font-size:14px;line-height:1.6;}' +
                '.logo-header{text-align:center;margin-bottom:20px;padding-bottom:14px;border-bottom:3px solid #008080;}' +
                '.logo-header img{height:44px;margin-bottom:6px;}' +
                '.logo-header .company-name{font-size:20px;font-weight:700;letter-spacing:2px;color:#1a1a2e;margin:0;}' +
                '.logo-header .doc-title{font-size:16px;color:#008080;margin-top:6px;font-weight:600;}' +
                '.logo-header .client-info{font-size:11px;color:#627d98;margin-top:3px;}' +
                'h2{color:#008080;font-size:16px;margin:22px 0 10px;padding-bottom:6px;border-bottom:2px solid #e2e8f0;}' +
                'h3{color:#334e68;font-size:14px;margin:14px 0 6px;}' +
                'h4{color:#486581;font-size:13px;margin:10px 0 4px;}' +
                'p,li{font-size:13px;color:#334e68;}' +
                'table{width:100%;border-collapse:collapse;margin:8px 0 16px;font-size:12px;}' +
                'th,td{border:1px solid #d1d5db;padding:7px 10px;text-align:left;}' +
                'th{background:#f0fdfa;color:#008080;font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;}' +
                'td{color:#334e68;}' +
                'tr:nth-child(even){background:#f9fafb;}' +
                'ul{padding-left:18px;margin:6px 0;}li{margin:3px 0;}' +
                '.section-box{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:14px 16px;margin:10px 0;}' +
                '.kv-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f3f4f6;font-size:13px;}' +
                '.kv-row:last-child{border-bottom:none;}' +
                '.kv-label{color:#627d98;font-weight:500;}' +
                '.kv-value{color:#1a1a2e;font-weight:600;text-align:right;}' +
                '.footer{text-align:center;margin-top:40px;padding-top:12px;border-top:2px solid #e2e8f0;font-size:10px;color:#829ab1;}' +
                '.footer strong{color:#334e68;}' +
                '.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;}' +
                '.badge-received,.badge-completed{background:#d1fae5;color:#065f46;}' +
                '.badge-pending{background:#fef3c7;color:#92400e;}' +
                '.badge-in-progress{background:#e0e7ff;color:#3730a3;}' +
                '@media print{body{padding:0;}.no-print{display:none;}}' +
                '</style>' +
                '</head><body>' +
                '<div class="logo-header">' +
                    '<img src="/images/logo.svg" alt="KINNOVANCE" onerror="this.style.display=\'none\'">' +
                    '<div class="company-name">KINNOVANCE</div>' +
                    '<div class="doc-title">' + doc.title + '</div>' +
                    (cName ? '<div class="client-info">Client: ' + cName + '</div>' : '') +
                    (pName ? '<div class="client-info">Project: ' + pName + '</div>' : '') +
                    '<div class="client-info">Date: ' + new Date(doc.createdAt).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) + '</div>' +
                '</div>' +
                bodyHtml +
                '<div class="footer">' +
                    '<p>This document is generated by <strong>KINNOVANCE</strong></p>' +
                    '<p>Confidential &mdash; For authorized use only</p>' +
                '</div>' +
                '</body></html>');
            } catch(e) {
                showToast('Error loading document', 'error');
            }
        }

        function clientFormatSectionTitle(key) {
            return key.replace(/([A-Z])/g, ' $1').replace(/^./, function(s){ return s.toUpperCase(); }).replace(/_/g, ' ');
        }

        function clientFormatValue(val) {
            if (val === null || val === undefined) return '\u2014';
            if (typeof val === 'boolean') return val ? 'Yes' : 'No';
            if (typeof val === 'number') return val.toLocaleString();
            if (typeof val === 'string' && val.match(/^\d{4}-\d{2}-\d{2}/)) {
                return new Date(val).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            }
            return String(val);
        }

        function clientRenderSections(obj, depth) {
            var skipKeys = ['companyName', 'companyLogo', 'footer', 'clientInfo', 'title', 'generatedDate', 'summary', 'icon'];
            var html = '';
            var keys = Object.keys(obj);
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                if (skipKeys.indexOf(key) !== -1) continue;
                var value = obj[key];
                if (value === null || value === undefined) continue;
                var title = clientFormatSectionTitle(key);
                var hTag = Math.min(depth + 2, 4);
                if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {
                    html += '<div class="kv-row"><span class="kv-label">' + title + '</span><span class="kv-value">' + clientFormatValue(value) + '</span></div>';
                } else if (Array.isArray(value)) {
                    html += '<h' + hTag + '>' + title + '</h' + hTag + '>';
                    if (value.length === 0) {
                        html += '<p style="color:#9ca3af;font-style:italic;">None</p>';
                    } else if (typeof value[0] === 'string') {
                        html += '<ul>' + value.map(function(v){ return '<li>' + v + '</li>'; }).join('') + '</ul>';
                    } else if (typeof value[0] === 'object') {
                        var tkeys = Object.keys(value[0]).filter(function(k){ return k !== '_id' && k !== 'icon'; });
                        html += '<table><thead><tr>' + tkeys.map(function(k){ return '<th>' + clientFormatSectionTitle(k) + '</th>'; }).join('') + '</tr></thead><tbody>';
                        value.forEach(function(row) {
                            html += '<tr>' + tkeys.map(function(k){
                                var v = row[k];
                                var cls = '';
                                if (k === 'status' && typeof v === 'string') cls = ' class="badge badge-' + v + '"';
                                return '<td><span' + cls + '>' + clientFormatValue(v) + '</span></td>';
                            }).join('') + '</tr>';
                        });
                        html += '</tbody></table>';
                    }
                } else if (typeof value === 'object') {
                    html += '<h' + hTag + '>' + title + '</h' + hTag + '>';
                    html += '<div class="section-box">' + clientRenderSections(value, depth + 1) + '</div>';
                }
            }
            return html;
        }

        function switchTab(tab) {
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) contents[i].classList.add('hidden');
            var tabs = document.querySelectorAll('.portal-tab');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('tab-active');
            document.getElementById('tab-' + tab).classList.remove('hidden');
            document.querySelector('[data-tab="' + tab + '"]').classList.add('tab-active');
        }

        function showToast(message, type) {
            type = type || 'info';
            var toast = document.createElement('div');
            var colors = { info: 'bg-blue-600', success: 'bg-emerald-600', error: 'bg-red-600' };
            toast.className = 'fixed bottom-4 right-4 ' + colors[type] + ' text-white px-6 py-3 rounded-xl shadow-2xl z-50 font-medium text-sm';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(function() { toast.remove(); }, 300); }, 3000);
        }

        async function markAssetUploaded(stageId, assetId) {
            try {
                await api.fetch('/projects/' + projectId + '/stages/' + stageId + '/asset-requests/' + assetId, 'PUT', { status: 'received' });
                showToast('Asset marked as uploaded!', 'success');
                await loadClientView();
            } catch(e) {
                showToast('Error updating asset status', 'error');
            }
        }

        async function uploadAssetFile(stageId, assetId, input) {
            if (!input.files || !input.files[0]) return;
            var file = input.files[0];
            if (file.size > 50 * 1024 * 1024) { showToast('File too large (max 50MB)', 'error'); return; }
            var formData = new FormData();
            formData.append('file', file);
            try {
                var token = localStorage.getItem('token');
                var res = await fetch('/api/projects/' + projectId + '/stages/' + stageId + '/asset-requests/' + assetId, {
                    method: 'PUT',
                    headers: { 'Authorization': 'Bearer ' + token },
                    body: formData
                });
                var data = await res.json();
                if (data.success) {
                    showToast('File uploaded successfully!', 'success');
                    await loadClientView();
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            } catch(e) {
                showToast('Error uploading file', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        init();
    </script>
</body>
</html>
