<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Project | Project Control System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-complete { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .step-active { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); }
        .step-pending { background: #e5e7eb; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Navigation Bar -->
    <nav class="bg-white border-b border-gray-100 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="/my-work" class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                    </div>
                    <span class="text-xl font-bold text-gray-800">ProjectControl</span>
                </a>
                <div class="hidden md:flex items-center space-x-1" id="navLinks">
                    <a href="/my-work" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-all">My Work</a>
                    <a href="/projects" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-all admin-subadmin-only">Projects</a>
                    <a href="/users" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-all admin-only">Users</a>
                    <a href="/documents" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-all admin-only">Documents</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/profile" class="flex items-center space-x-3 hover:bg-gray-50 rounded-lg px-2 py-1 transition-all">
                        <div class="w-9 h-9 bg-gradient-to-br from-emerald-400 to-cyan-500 rounded-full flex items-center justify-center text-white font-semibold text-sm"><span id="userInitials">AK</span></div>
                        <span class="hidden sm:block text-sm font-medium text-gray-700" id="userName">Admin</span>
                    </a>
                    <button onclick="logout()" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Logout">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Create New Project</h1>
            <p class="text-gray-500 mt-1">Fill in the details to set up a new project</p>
        </div>

        <!-- Stepper -->
        <div class="mb-10">
            <div class="flex items-center justify-between relative">
                <div class="absolute top-6 left-0 right-0 h-0.5 bg-gray-200 z-0"></div>
                <div id="progressLine" class="absolute top-6 left-0 h-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 z-0 transition-all duration-500" style="width: 0%"></div>
                
                <div class="flex flex-col items-center z-10 step-indicator" data-step="1">
                    <div id="step1Circle" class="w-12 h-12 rounded-full step-active flex items-center justify-center text-white font-bold shadow-lg transition-all">1</div>
                    <span class="mt-2 text-sm font-medium text-indigo-600">Basic Info</span>
                </div>
                <div class="flex flex-col items-center z-10 step-indicator" data-step="2">
                    <div id="step2Circle" class="w-12 h-12 rounded-full step-pending flex items-center justify-center text-gray-400 font-bold transition-all">2</div>
                    <span class="mt-2 text-sm font-medium text-gray-400">Team</span>
                </div>
                <div class="flex flex-col items-center z-10 step-indicator" data-step="3">
                    <div id="step3Circle" class="w-12 h-12 rounded-full step-pending flex items-center justify-center text-gray-400 font-bold transition-all">3</div>
                    <span class="mt-2 text-sm font-medium text-gray-400">Payment</span>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden mb-4 p-4 bg-red-50 border border-red-200 text-red-700 rounded-xl"></div>

        <!-- Form Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <form id="projectForm" onsubmit="return false;">

                <!-- ==================== Step 1: Basic Info ==================== -->
                <div id="step1Content" class="step-content p-8">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Basic Information</h2>
                            <p class="text-gray-500 text-sm">Enter project details</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project Name *</label>
                            <input type="text" id="projectName" placeholder="Enter project name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none" required>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                            <textarea id="projectDescription" rows="3" placeholder="Brief project description..." class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none resize-none"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Client Name *</label>
                            <input type="text" id="clientName" placeholder="Enter client name" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Project Type *</label>
                            <select id="projectType" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none bg-white" required>
                                <option value="">Select type</option>
                                <option value="web">Web Application</option>
                                <option value="mobile">Mobile App</option>
                                <option value="desktop">Desktop Application</option>
                                <option value="ecommerce">E-Commerce</option>
                                <option value="crm">CRM/ERP System</option>
                                <option value="api">API Development</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Priority *</label>
                            <div class="flex gap-3">
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="priority" value="low" class="peer hidden">
                                    <div class="text-center py-3 px-4 rounded-xl border-2 border-gray-200 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700 transition-all font-medium">Low</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="priority" value="medium" class="peer hidden" checked>
                                    <div class="text-center py-3 px-4 rounded-xl border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition-all font-medium">Medium</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="priority" value="high" class="peer hidden">
                                    <div class="text-center py-3 px-4 rounded-xl border-2 border-gray-200 peer-checked:border-orange-500 peer-checked:bg-orange-50 peer-checked:text-orange-700 transition-all font-medium">High</div>
                                </label>
                                <label class="flex-1 cursor-pointer">
                                    <input type="radio" name="priority" value="critical" class="peer hidden">
                                    <div class="text-center py-3 px-4 rounded-xl border-2 border-gray-200 peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 transition-all font-medium">Critical</div>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="startDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Expected Delivery Date</label>
                            <input type="date" id="dueDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none">
                        </div>
                    </div>
                </div>

                <!-- ==================== Step 2: Team ==================== -->
                <div id="step2Content" class="step-content p-8 hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Team Assignment</h2>
                            <p class="text-gray-500 text-sm">Assign team members to this project</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Project Manager -->
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-2xl border border-indigo-100">
                            <label class="block text-sm font-medium text-indigo-700 mb-2">Project Manager *</label>
                            <select id="teamPM" class="w-full px-4 py-3 border border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none bg-white">
                                <option value="">Select PM</option>
                            </select>
                        </div>
                        
                        <!-- Designer -->
                        <div class="bg-gradient-to-br from-pink-50 to-rose-50 p-5 rounded-2xl border border-pink-100">
                            <label class="block text-sm font-medium text-pink-700 mb-2">Designer</label>
                            <select id="teamDesigner" class="w-full px-4 py-3 border border-pink-200 rounded-xl focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all outline-none bg-white">
                                <option value="">Select Designer</option>
                            </select>
                        </div>
                        
                        <!-- Frontend Developer -->
                        <div class="bg-gradient-to-br from-cyan-50 to-blue-50 p-5 rounded-2xl border border-cyan-100">
                            <label class="block text-sm font-medium text-cyan-700 mb-2">Frontend Developer</label>
                            <select id="teamFrontend" class="w-full px-4 py-3 border border-cyan-200 rounded-xl focus:ring-2 focus:ring-cyan-500 focus:border-transparent transition-all outline-none bg-white">
                                <option value="">Select Frontend Dev</option>
                            </select>
                        </div>
                        
                        <!-- Backend Developer -->
                        <div class="bg-gradient-to-br from-emerald-50 to-green-50 p-5 rounded-2xl border border-emerald-100">
                            <label class="block text-sm font-medium text-emerald-700 mb-2">Backend Developer</label>
                            <select id="teamBackend" class="w-full px-4 py-3 border border-emerald-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all outline-none bg-white">
                                <option value="">Select Backend Dev</option>
                            </select>
                        </div>
                        
                        <!-- QA Engineer -->
                        <div class="bg-gradient-to-br from-amber-50 to-yellow-50 p-5 rounded-2xl border border-amber-100">
                            <label class="block text-sm font-medium text-amber-700 mb-2">QA Engineer</label>
                            <select id="teamQA" class="w-full px-4 py-3 border border-amber-200 rounded-xl focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all outline-none bg-white">
                                <option value="">Select QA</option>
                            </select>
                        </div>
                        
                        <!-- DevOps -->
                        <div class="bg-gradient-to-br from-slate-50 to-gray-100 p-5 rounded-2xl border border-slate-200">
                            <label class="block text-sm font-medium text-slate-700 mb-2">DevOps Engineer</label>
                            <select id="teamDevOps" class="w-full px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all outline-none bg-white">
                                <option value="">Select DevOps</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ==================== Step 3: Payment ==================== -->
                <div id="step3Content" class="step-content p-8 hidden">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900">Payment Setup</h2>
                            <p class="text-gray-500 text-sm">Configure project payment milestones</p>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Total Amount -->
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-2xl">
                            <label class="block text-sm font-medium text-white/80 mb-2">Total Project Amount *</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 -translate-y-1/2 text-lg font-bold text-gray-400">$</span>
                                <input type="number" id="totalAmount" placeholder="0.00" class="w-full pl-10 pr-4 py-4 text-2xl font-bold border-0 rounded-xl focus:ring-2 focus:ring-white focus:ring-opacity-50 outline-none" required>
                            </div>
                        </div>
                        
                        <!-- Advance & Milestones Config -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Advance Percentage</label>
                                <div class="relative">
                                    <input type="number" id="advancePercent" placeholder="25" min="0" max="100" value="25" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none">
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">%</span>
                                </div>
                                <p class="text-xs text-gray-400 mt-1">Advance amount: $<span id="advanceAmountDisplay">0.00</span></p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Milestones</label>
                                <select id="milestoneCount" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all outline-none bg-white">
                                    <option value="1">1 Milestone</option>
                                    <option value="2">2 Milestones</option>
                                    <option value="3" selected>3 Milestones</option>
                                    <option value="4">4 Milestones</option>
                                    <option value="5">5 Milestones</option>
                                    <option value="6">6 Milestones</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Milestone Breakdown with Editable % -->
                        <div id="milestoneBreakdown" class="bg-gray-50 p-5 rounded-2xl border border-gray-100">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-sm font-medium text-gray-700">Payment Breakdown</h4>
                                <span class="text-xs font-medium px-2 py-1 rounded-lg" id="totalPercentBadge">Total: 100%</span>
                            </div>
                            <div class="space-y-3" id="milestoneList"></div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="px-8 py-5 bg-gray-50 border-t border-gray-100 flex justify-between">
                    <button type="button" id="prevBtn" onclick="prevStep()" class="px-6 py-2.5 text-gray-600 font-medium rounded-xl hover:bg-gray-100 transition-all hidden">
                        ← Previous
                    </button>
                    
                    <div class="flex gap-3 ml-auto">
                        <a class='px-6 py-2.5 text-gray-600 font-medium rounded-xl hover:bg-gray-100 transition-all' href='/projects'>Cancel</a>
                        <button type="button" id="nextBtn" onclick="nextStep()" class="px-6 py-2.5 bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-medium rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all">
                            Next Step →
                        </button>
                        <button type="button" id="submitBtn" onclick="createProject()" class="px-6 py-2.5 bg-gradient-to-r from-emerald-500 to-teal-600 text-white font-medium rounded-xl hover:shadow-lg transform hover:-translate-y-0.5 transition-all hidden">
                            Create Project ✓
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 3;
        let allUsers = [];
        let milestonePercents = []; // stores % for each milestone

        // ==================== STEPPER ====================
        function updateStepper() {
            const progressLine = document.getElementById('progressLine');
            progressLine.style.width = `${((currentStep - 1) / (totalSteps - 1)) * 100}%`;
            
            for (let i = 1; i <= totalSteps; i++) {
                const circle = document.getElementById(`step${i}Circle`);
                const indicator = document.querySelector(`.step-indicator[data-step="${i}"]`);
                const label = indicator.querySelector('span');
                
                if (i < currentStep) {
                    circle.className = 'w-12 h-12 rounded-full step-complete flex items-center justify-center text-white font-bold shadow-lg transition-all';
                    circle.innerHTML = '✓';
                    label.className = 'mt-2 text-sm font-medium text-emerald-600';
                } else if (i === currentStep) {
                    circle.className = 'w-12 h-12 rounded-full step-active flex items-center justify-center text-white font-bold shadow-lg transition-all';
                    circle.innerHTML = i;
                    label.className = 'mt-2 text-sm font-medium text-indigo-600';
                } else {
                    circle.className = 'w-12 h-12 rounded-full step-pending flex items-center justify-center text-gray-400 font-bold transition-all';
                    circle.innerHTML = i;
                    label.className = 'mt-2 text-sm font-medium text-gray-400';
                }
            }
            
            document.querySelectorAll('.step-content').forEach((c, i) => {
                c.classList.toggle('hidden', i + 1 !== currentStep);
            });
            
            document.getElementById('prevBtn').classList.toggle('hidden', currentStep === 1);
            document.getElementById('nextBtn').classList.toggle('hidden', currentStep === totalSteps);
            document.getElementById('submitBtn').classList.toggle('hidden', currentStep !== totalSteps);
        }

        function validateStep(step) {
            if (step === 1) {
                const name = document.getElementById('projectName').value.trim();
                const client = document.getElementById('clientName').value.trim();
                const type = document.getElementById('projectType').value;
                if (!name || !client || !type) {
                    showError('Please fill in Project Name, Client Name, and Type');
                    return false;
                }
            } else if (step === 2) {
                const pm = document.getElementById('teamPM').value;
                if (!pm) {
                    showError('Please select a Project Manager');
                    return false;
                }
            } else if (step === 3) {
                const total = parseFloat(document.getElementById('totalAmount').value);
                if (!total || total <= 0) {
                    showError('Please enter a valid total amount');
                    return false;
                }
                // check percentages sum
                const advPct = parseFloat(document.getElementById('advancePercent').value) || 0;
                const msPct = milestonePercents.reduce((s, p) => s + p, 0);
                const sum = advPct + msPct;
                if (Math.abs(sum - 100) > 0.5) {
                    showError(`Total percentage is ${sum.toFixed(1)}%. It must equal 100%.`);
                    return false;
                }
            }
            return true;
        }

        function nextStep() {
            if (validateStep(currentStep)) {
                currentStep++;
                updateStepper();
                if (currentStep === 3) renderMilestones();
            }
        }

        function prevStep() {
            currentStep--;
            updateStepper();
        }

        // ==================== LOAD USERS ====================
        async function loadUsers() {
            try {
                const result = await api.getUsers();
                if (result.success && result.data) {
                    allUsers = result.data;
                } else if (Array.isArray(result)) {
                    allUsers = result;
                }
                populateTeamDropdowns();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function populateTeamDropdowns() {
            const roles = [
                { selectId: 'teamPM', label: 'Select PM' },
                { selectId: 'teamDesigner', label: 'Select Designer' },
                { selectId: 'teamFrontend', label: 'Select Frontend Dev' },
                { selectId: 'teamBackend', label: 'Select Backend Dev' },
                { selectId: 'teamQA', label: 'Select QA' },
                { selectId: 'teamDevOps', label: 'Select DevOps' }
            ];
            
            roles.forEach(({ selectId, label }) => {
                const select = document.getElementById(selectId);
                select.innerHTML = `<option value="">${label}</option>`;
                allUsers.forEach(user => {
                    select.innerHTML += `<option value="${user._id}" data-name="${user.name}">${user.name} (${user.role})</option>`;
                });
            });
        }

        // ==================== MILESTONE PERCENTAGES ====================
        function renderMilestones() {
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            const advPct = parseFloat(document.getElementById('advancePercent').value) || 0;
            const count = parseInt(document.getElementById('milestoneCount').value) || 3;
            const advanceAmount = (total * advPct / 100);
            
            document.getElementById('advanceAmountDisplay').textContent = advanceAmount.toFixed(2);
            
            // Initialize milestone percents if needed
            const remainingPct = 100 - advPct;
            if (milestonePercents.length !== count) {
                const each = count > 0 ? parseFloat((remainingPct / count).toFixed(1)) : 0;
                milestonePercents = Array(count).fill(each);
                // Fix rounding so it sums correctly
                const diff = remainingPct - milestonePercents.reduce((s, p) => s + p, 0);
                if (milestonePercents.length > 0) {
                    milestonePercents[milestonePercents.length - 1] = parseFloat((milestonePercents[milestonePercents.length - 1] + diff).toFixed(1));
                }
            }
            
            let html = `
                <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <span class="w-8 h-8 bg-emerald-500 text-white rounded-lg flex items-center justify-center text-sm font-bold">A</span>
                        <span class="text-sm font-medium text-emerald-700">Advance</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="text-sm text-emerald-600 font-medium">${advPct}%</span>
                        <span class="font-bold text-emerald-700 min-w-[80px] text-right">$${advanceAmount.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            for (let i = 0; i < count; i++) {
                const pct = milestonePercents[i] || 0;
                const amount = (total * pct / 100);
                html += `
                    <div class="flex items-center justify-between p-3 bg-white rounded-xl border border-gray-100">
                        <div class="flex items-center gap-3">
                            <span class="w-8 h-8 bg-indigo-500 text-white rounded-lg flex items-center justify-center text-sm font-bold">${i + 1}</span>
                            <span class="text-sm font-medium text-gray-700">Milestone ${i + 1}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="number" value="${pct}" min="0" max="100" step="0.1"
                                   onchange="updateMilestonePercent(${i}, this.value)"
                                   oninput="updateMilestonePercent(${i}, this.value)"
                                   class="w-20 px-2 py-1.5 text-sm text-center border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none font-medium">
                            <span class="text-gray-400 text-sm">%</span>
                            <span class="font-bold text-gray-700 min-w-[80px] text-right" id="msAmt${i}">$${amount.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('milestoneList').innerHTML = html;
            updateTotalPercentBadge();
        }

        function updateMilestonePercent(index, value) {
            milestonePercents[index] = parseFloat(value) || 0;
            
            // Recalculate amounts
            const total = parseFloat(document.getElementById('totalAmount').value) || 0;
            for (let i = 0; i < milestonePercents.length; i++) {
                const amount = (total * milestonePercents[i] / 100);
                const el = document.getElementById(`msAmt${i}`);
                if (el) el.textContent = `$${amount.toFixed(2)}`;
            }
            
            updateTotalPercentBadge();
        }

        function updateTotalPercentBadge() {
            const advPct = parseFloat(document.getElementById('advancePercent').value) || 0;
            const msPct = milestonePercents.reduce((s, p) => s + p, 0);
            const sum = advPct + msPct;
            const badge = document.getElementById('totalPercentBadge');
            
            if (Math.abs(sum - 100) < 0.5) {
                badge.textContent = `Total: ${sum.toFixed(1)}% ✓`;
                badge.className = 'text-xs font-medium px-2 py-1 rounded-lg bg-emerald-100 text-emerald-700';
            } else {
                badge.textContent = `Total: ${sum.toFixed(1)}% (must be 100%)`;
                badge.className = 'text-xs font-medium px-2 py-1 rounded-lg bg-red-100 text-red-700';
            }
        }

        // Listeners for live recalculation
        document.getElementById('totalAmount').addEventListener('input', renderMilestones);
        document.getElementById('advancePercent').addEventListener('input', () => {
            // reset milestones to redistribute evenly
            milestonePercents = [];
            renderMilestones();
        });
        document.getElementById('milestoneCount').addEventListener('change', () => {
            milestonePercents = [];
            renderMilestones();
        });

        // ==================== CREATE PROJECT ====================
        async function createProject() {
            if (!validateStep(3)) return;
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating...';
            
            // Build team array matching TeamMemberSchema
            const team = [];
            const teamRoles = [
                { selectId: 'teamPM', role: 'Project Manager' },
                { selectId: 'teamDesigner', role: 'Designer' },
                { selectId: 'teamFrontend', role: 'Frontend Dev' },
                { selectId: 'teamBackend', role: 'Backend Dev' },
                { selectId: 'teamQA', role: 'QA Engineer' },
                { selectId: 'teamDevOps', role: 'DevOps' }
            ];
            
            teamRoles.forEach(({ selectId, role }) => {
                const select = document.getElementById(selectId);
                if (select.value) {
                    const selectedOption = select.options[select.selectedIndex];
                    team.push({
                        role: role,
                        user: select.value,
                        name: selectedOption.getAttribute('data-name') || selectedOption.textContent
                    });
                }
            });
            
            const projectData = {
                name: document.getElementById('projectName').value.trim(),
                client: document.getElementById('clientName').value.trim(),
                type: document.getElementById('projectType').value,
                priority: document.querySelector('input[name="priority"]:checked')?.value || 'medium',
                dueDate: document.getElementById('dueDate').value || undefined,
                startDate: document.getElementById('startDate').value || undefined,
                description: document.getElementById('projectDescription').value.trim(),
                team: team,
                totalAmount: parseFloat(document.getElementById('totalAmount').value) || 0,
                advancePercent: parseFloat(document.getElementById('advancePercent').value) || 0,
                milestones: parseInt(document.getElementById('milestoneCount').value) || 3
            };
            
            try {
                const result = await api.createProject(projectData);
                
                if (result.success) {
                    // Redirect to project detail or projects list
                    const projectId = result.data?._id || result.data?.id;
                    if (projectId) {
                        window.location.href = `/project-detail?id=${projectId}`;
                    } else {
                        window.location.href = '/projects';
                    }
                } else {
                    showError(result.error || 'Failed to create project');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Project ✓';
                }
            } catch (error) {
                showError('Connection failed. Please try again.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Project ✓';
            }
        }

        // ==================== UTILITY ====================
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        async function init() {
            if (!api.isLoggedIn()) {
                window.location.href = '/login';
                return;
            }
            
            const user = api.getUser();
            if (!user || !user.name) {
                window.location.href = '/login';
                return;
            }
            
            if (user.role !== 'admin') {
                window.location.href = '/my-work';
                return;
            }
            
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userInitials').textContent = user.name.split(' ').map(n => n[0]).join('').substring(0, 2);
            
            if (user.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
            }
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            const threeMonths = new Date();
            threeMonths.setMonth(threeMonths.getMonth() + 3);
            document.getElementById('dueDate').value = threeMonths.toISOString().split('T')[0];
            
            updateStepper();
            await loadUsers();
        }

        init();
    </script>
</body>
</html>
